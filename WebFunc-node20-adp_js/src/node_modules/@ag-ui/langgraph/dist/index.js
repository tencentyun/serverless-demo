"use strict";var Y=Object.defineProperty,Et=Object.defineProperties,vt=Object.getOwnPropertyDescriptor,_t=Object.getOwnPropertyDescriptors,Tt=Object.getOwnPropertyNames,V=Object.getOwnPropertySymbols;var tt=Object.prototype.hasOwnProperty,ht=Object.prototype.propertyIsEnumerable;var ot=(s,n)=>(n=Symbol[s])?n:Symbol.for("Symbol."+s);var lt=(s,n,t)=>n in s?Y(s,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[n]=t,f=(s,n)=>{for(var t in n||(n={}))tt.call(n,t)&&lt(s,t,n[t]);if(V)for(var t of V(n))ht.call(n,t)&&lt(s,t,n[t]);return s},T=(s,n)=>Et(s,_t(n));var et=(s,n)=>{var t={};for(var e in s)tt.call(s,e)&&n.indexOf(e)<0&&(t[e]=s[e]);if(s!=null&&V)for(var e of V(s))n.indexOf(e)<0&&ht.call(s,e)&&(t[e]=s[e]);return t};var It=(s,n)=>{for(var t in n)Y(s,t,{get:n[t],enumerable:!0})},Mt=(s,n,t,e)=>{if(n&&typeof n=="object"||typeof n=="function")for(let a of Tt(n))!tt.call(s,a)&&a!==t&&Y(s,a,{get:()=>n[a],enumerable:!(e=vt(n,a))||e.enumerable});return s};var Rt=s=>Mt(Y({},"__esModule",{value:!0}),s);var dt=(s,n,t)=>(n=s[ot("asyncIterator")])?n.call(s):(s=s[ot("iterator")](),n={},t=(e,a)=>(a=s[e])&&(n[e]=i=>new Promise((r,u,g)=>(i=a.call(s,i),g=i.done,Promise.resolve(i.value).then(l=>r({value:l,done:g}),u)))),t("next"),t("return"),n);var Nt={};It(Nt,{CustomEventNames:()=>ut,LangGraphAgent:()=>st,LangGraphEventTypes:()=>ct,LangGraphHttpAgent:()=>it});module.exports=Rt(Nt);var St=require("@ag-ui/client");var ft=require("rxjs"),yt=require("@langchain/langgraph-sdk"),B=require("@ag-ui/client");var ct=(d=>(d.OnChainStart="on_chain_start",d.OnChainStream="on_chain_stream",d.OnChainEnd="on_chain_end",d.OnChatModelStart="on_chat_model_start",d.OnChatModelStream="on_chat_model_stream",d.OnChatModelEnd="on_chat_model_end",d.OnToolStart="on_tool_start",d.OnToolEnd="on_tool_end",d.OnCustomEvent="on_custom_event",d.OnInterrupt="on_interrupt",d))(ct||{}),ut=(a=>(a.ManuallyEmitMessage="manually_emit_message",a.ManuallyEmitToolCall="manually_emit_tool_call",a.ManuallyEmitState="manually_emit_state",a.Exit="exit",a))(ut||{});var o=require("@ag-ui/client");var nt=["messages","tools"];function Q(s,n){return Object.fromEntries(Object.entries(s).filter(([t])=>n.includes(t)))}function gt({mode:s,state:n,schemaKeys:t}){let e=s==="start"?n:null;return e&&(t!=null&&t.input)&&(e=Q(e,[...nt,...t.input])),e}function Ct(s){var t;let n=[];for(let e of s)if(e.type==="text"&&e.text)n.push({type:"text",text:e.text});else if(e.type==="image_url"){let a=typeof e.image_url=="string"?e.image_url:(t=e.image_url)==null?void 0:t.url;if(!a)continue;if(a.startsWith("data:")){let[i,r]=a.split(",",2),u=i.includes(":")?i.split(":")[1].split(";")[0]:"image/png";n.push({type:"binary",mimeType:u,data:r||""})}else n.push({type:"binary",mimeType:"image/png",url:a})}return n}function xt(s){let n=[];for(let t of s)if(t.type==="text")n.push({type:"text",text:t.text});else if(t.type==="binary"){let e;if(t.url)e=t.url;else if(t.data)e=`data:${t.mimeType};base64,${t.data}`;else if(t.id)e=t.id;else continue;n.push({type:"image_url",image_url:{url:e}})}return n}function pt(s){return s.map(n=>{var t;switch(n.type){case"human":let e;return Array.isArray(n.content)?e=Ct(n.content):e=z(K(n.content)),{id:n.id,role:"user",content:e};case"ai":let a=K(n.content);return{id:n.id,role:"assistant",content:a?z(a):"",toolCalls:(t=n.tool_calls)==null?void 0:t.map(i=>({id:i.id,type:"function",function:{name:i.name,arguments:JSON.stringify(i.args)}}))};case"system":return{id:n.id,role:"system",content:z(K(n.content))};case"tool":return{id:n.id,role:"tool",content:z(K(n.content)),toolCallId:n.tool_call_id};default:throw new Error("message type returned from LangGraph is not supported.")}})}function at(s){return s.map((n,t)=>{var e,a;switch(n.role){case"user":let i;return typeof n.content=="string"?i=n.content:Array.isArray(n.content)?i=xt(n.content):i=String(n.content),{id:n.id,role:n.role,content:i,type:"human"};case"assistant":return{id:n.id,type:"ai",role:n.role,content:(e=n.content)!=null?e:"",tool_calls:((a=n.toolCalls)!=null?a:[]).map(r=>({id:r.id,name:r.function.name,args:JSON.parse(r.function.arguments),type:"tool_call"}))};case"system":return{id:n.id,role:n.role,content:n.content,type:"system"};case"tool":return{content:n.content,role:n.role,type:n.role,tool_call_id:n.toolCallId,id:n.id};default:throw console.error(`Message role ${n.role} is not implemented`),new Error("message role is not supported.")}})}function z(s){return typeof s=="string"?s:JSON.stringify(s)}function mt(s){var t,e,a,i,r;let n=(t=s.chunk)==null?void 0:t.content;if(n&&Array.isArray(n)&&n.length&&n[0])return n[0].thinking?{text:n[0].thinking,type:"text",index:n[0].index}:null;if((i=(a=(e=s.chunk.additional_kwargs)==null?void 0:e.reasoning)==null?void 0:a.summary)!=null&&i[0]){let u=(r=s.chunk.additional_kwargs)==null?void 0:r.reasoning.summary[0];return!u||!u.text?null:{type:"text",text:u.text,index:u.index}}return null}function K(s){var n;if(!s)return null;if(typeof s=="string")return s;if(Array.isArray(s)&&s.length){let t=(n=s.find(e=>e.type==="text"))==null?void 0:n.text;return t!=null?t:null}return null}var st=class s extends o.AbstractAgent{constructor(t){var e,a;super(t);this.cancelRequested=!1;this.cancelSent=!1;this.constantSchemaKeys=nt;this.config=t,this.messagesInProcess={},this.agentName=t.agentName,this.graphId=t.graphId,this.assistantConfig=t.assistantConfig,this.thinkingProcess=null,this.client=(a=t==null?void 0:t.client)!=null?a:new yt.Client({apiUrl:t.deploymentUrl,apiKey:t.langsmithApiKey,defaultHeaders:f({},(e=t.propertyHeaders)!=null?e:{})})}clone(){return new s(this.config)}dispatchEvent(t){return this.subscriber.next(t),!0}run(t){return new ft.Observable(e=>(this.runAgentStream(t,e),()=>{}))}async runAgentStream(t,e){var u,g,l;this.activeRun={id:t.runId,threadId:t.threadId,hasFunctionStreaming:!1},this.cancelRequested=!1,this.cancelSent=!1,this.subscriber=e,this.assistant||(this.assistant=await this.getAssistant());let a=(u=t.threadId)!=null?u:(0,B.randomUUID)(),i=(l=(g=t.forwardedProps)==null?void 0:g.streamMode)!=null?l:["events","values","updates"],r=await this.prepareStream(T(f({},t),{threadId:a}),i);if(!r)return e.error("No stream to regenerate");await this.handleStreamEvents(r,a,e,t,Array.isArray(i)?i:[i])}async prepareRegenerateStream(t,e){var l,d,c;let{threadId:a,messageCheckpoint:i}=t,r=await this.getCheckpointByMessage(i.id,a);if(this.assistant||(this.assistant=await this.getAssistant()),!r)return this.subscriber.error("No checkpoint found for message");let u=await this.client.threads.updateState(a,{values:this.langGraphDefaultMergeState(r.values,[],t),checkpointId:r.checkpoint.checkpoint_id,asNode:(d=(l=r.next)==null?void 0:l[0])!=null?d:"__start__"}),g=T(f({},(c=t.forwardedProps)!=null?c:{}),{input:this.langGraphDefaultMergeState(r.values,[i],t),checkpointId:u.checkpoint.checkpoint_id,streamMode:e});return{streamResponse:this.client.runs.stream(a,this.assistant.assistant_id,g),state:r,streamMode:e}}async prepareStream(t,e){var L,w,b,y,G,O,$,X,U,E;let{threadId:a,state:i,messages:r,tools:u,context:g,forwardedProps:l}=t;this.activeRun.manuallyEmittedState=null;let d=l==null?void 0:l.nodeName,c=a!=null?a:(0,B.randomUUID)();this.assistant||(this.assistant=await this.getAssistant());let S=await this.getOrCreateThread(c,l==null?void 0:l.threadMetadata);this.activeRun.threadId=S.thread_id;let _=(L=await this.client.threads.getState(S.thread_id))!=null?L:{values:{}},I=(w=_.values.messages)!=null?w:[],x=at(r),R=this.langGraphDefaultMergeState(T(f({},i),{messages:I}),x,t),N=T(f({},_),{values:T(f({},R),{messages:[...I,...(b=R.messages)!=null?b:[]]})}),A=N.values;if(this.activeRun.schemaKeys=await this.getSchemaKeys(),((y=_.values.messages)!=null?y:[]).length>r.filter(v=>v.role!=="system").length){let v=null;for(let P=r.length-1;P>=0;P--)if(r[P].role==="user"){v=at([r[P]])[0];break}return v?this.prepareRegenerateStream(T(f({},t),{messageCheckpoint:v}),e):this.subscriber.error("No user message found in messages to regenerate")}this.activeRun.graphInfo=await this.client.assistants.getGraph(this.assistant.assistant_id);let p=!((G=l==null?void 0:l.command)!=null&&G.resume)&&c&&this.activeRun.nodeName!="__end__"&&this.activeRun.nodeName?"continue":"start";if(p==="continue"){let v=this.activeRun.graphInfo.edges.find(P=>P.target===this.activeRun.nodeName);await this.client.threads.updateState(c,{values:i,asNode:v==null?void 0:v.source})}let M=gt({mode:p,state:A,schemaKeys:this.activeRun.schemaKeys}),m,J=[this.assistantConfig,l==null?void 0:l.config].filter(Boolean);J.length&&(m=await this.mergeConfigs({configs:J,assistant:this.assistant,schemaKeys:this.activeRun.schemaKeys}));let h=l,{command:k}=h,W=et(h,["command"]);if(k!=null&&k.resume&&typeof k.resume=="string")try{k.resume=JSON.parse(k.resume)}catch(v){}let j=T(f({},W),{command:k,streamMode:e,input:M,config:m,context:f(f({},g),(O=m==null?void 0:m.configurable)!=null?O:{})}),C=(U=(X=($=_.tasks)==null?void 0:$[0])==null?void 0:X.interrupts)!=null?U:[];return C!=null&&C.length&&!((E=l==null?void 0:l.command)!=null&&E.resume)?(this.dispatchEvent({type:o.EventType.RUN_STARTED,threadId:c,runId:t.runId}),this.handleNodeChange(d),C.forEach(v=>{this.dispatchEvent({type:o.EventType.CUSTOM,name:"on_interrupt",value:typeof v.value=="string"?v.value:JSON.stringify(v.value),rawEvent:v})}),this.dispatchEvent({type:o.EventType.RUN_FINISHED,threadId:c,runId:t.runId}),this.subscriber.complete()):{streamResponse:this.client.runs.stream(c,this.assistant.assistant_id,j),state:N}}async handleStreamEvents(t,e,a,i,r){var I,x,R,N,A,p,M,m,C,L,w,b,y,G;let{forwardedProps:u}=i,g=u==null?void 0:u.nodeName;this.subscriber=a;let l=!1;if(!t)return;let{streamResponse:d,state:c}=t;this.activeRun.prevNodeName=null;let S={},_=c;try{this.dispatchEvent({type:o.EventType.RUN_STARTED,threadId:e,runId:this.activeRun.id}),this.handleNodeChange(g);try{for(var J=dt(d),k,W,j;k=!(W=await J.next()).done;k=!1){let E=W.value;if(this.cancelRequested&&!this.cancelSent&&((I=this.activeRun)!=null&&I.threadId)&&((x=this.activeRun)!=null&&x.id)){try{await this.client.runs.cancel(this.activeRun.threadId,this.activeRun.id)}catch(q){}finally{this.cancelSent=!0}try{await((R=d==null?void 0:d.return)==null?void 0:R.call(d))}catch(q){}break}let v=(N=i.forwardedProps)==null?void 0:N.streamSubgraphs,P=v&&(E.event.startsWith("events")||E.event.startsWith("values"));if(!r.includes(E.event)&&!P&&E.event!=="error")continue;let F=E;if(E.event==="error"){this.dispatchEvent({type:o.EventType.RUN_ERROR,message:E.data.message,rawEvent:E});break}if(E.event==="updates")continue;if(E.event==="values"){S=F.data;continue}else if(v&&F.event.startsWith("values|")){S=f(f({},S),F.data);continue}let H=F.data,Z=(A=H.metadata)!=null?A:{},D=Z.langgraph_node,rt=H.event;if(Z.run_id&&(this.activeRun.id=Z.run_id,this.activeRun.serverRunIdKnown=!0,this.cancelRequested&&!this.cancelSent&&((p=this.activeRun)!=null&&p.threadId)))try{await this.client.runs.cancel(this.activeRun.threadId,this.activeRun.id)}catch(q){}finally{this.cancelSent=!0}if(D&&D!==this.activeRun.nodeName&&this.handleNodeChange(D),l=l||rt==="on_custom_event"&&H.name==="exit",rt==="on_chain_end"&&this.activeRun.nodeName===D&&(this.activeRun.exitingNode=!0),this.activeRun.exitingNode&&(this.activeRun.manuallyEmittedState=null),(M=this.activeRun.graphInfo)!=null&&M.nodes.some(q=>q.id===D)&&this.handleNodeChange(D),_.values=(m=this.activeRun.manuallyEmittedState)!=null?m:S,!this.activeRun.nodeName)continue;(JSON.stringify(_)!==JSON.stringify(c)||this.activeRun.prevNodeName!=this.activeRun.nodeName||this.activeRun.exitingNode)&&!this.getMessageInProgress(this.activeRun.id)&&(c=_,this.activeRun.prevNodeName=this.activeRun.nodeName,this.dispatchEvent({type:o.EventType.STATE_SNAPSHOT,snapshot:this.getStateSnapshot(c),rawEvent:F})),this.dispatchEvent({type:o.EventType.RAW,event:H}),this.handleSingleEvent(H)}}catch(W){j=[W]}finally{try{k&&(W=J.return)&&await W.call(J)}finally{if(j)throw j[0]}}c=await this.client.threads.getState(e);let h=c.tasks,O=(L=(C=h==null?void 0:h[0])==null?void 0:C.interrupts)!=null?L:[],$=c.next.length===0,X=(b=(w=c.metadata)==null?void 0:w.writes)!=null?b:{},U=this.activeRun.nodeName;return O!=null&&O.length||(U=$?"__end__":(y=c.next[0])!=null?y:Object.keys(X)[0]),O.forEach(E=>{this.dispatchEvent({type:o.EventType.CUSTOM,name:"on_interrupt",value:typeof E.value=="string"?E.value:JSON.stringify(E.value),rawEvent:E})}),this.handleNodeChange(U),this.handleNodeChange(void 0),this.dispatchEvent({type:o.EventType.STATE_SNAPSHOT,snapshot:this.getStateSnapshot(c)}),this.dispatchEvent({type:o.EventType.MESSAGES_SNAPSHOT,messages:pt((G=c.values.messages)!=null?G:[])}),this.dispatchEvent({type:o.EventType.RUN_FINISHED,threadId:e,runId:this.activeRun.id}),this.cancelRequested=!1,this.cancelSent=!1,this.activeRun=void 0,a.complete()}catch(h){return a.error(h)}}handleSingleEvent(t){var e,a,i,r,u,g,l,d,c,S,_,I,x,R;switch(t.event){case"on_chat_model_stream":let N=(e=t.metadata["emit-messages"])!=null?e:!0,A=(a=t.metadata["emit-tool-calls"])!=null?a:!0;if(t.data.chunk.response_metadata.finish_reason)return;let p=this.getMessageInProgress(this.activeRun.id),M=!!(p!=null&&p.id),m=(i=t.data.chunk.tool_call_chunks)==null?void 0:i[0],J=(r=t.metadata.predict_state)==null?void 0:r.some(h=>h.tool===(m==null?void 0:m.name)),k=!M&&(m==null?void 0:m.name),W=M&&(p==null?void 0:p.toolCallId)&&(m==null?void 0:m.args),j=M&&(p==null?void 0:p.toolCallId)&&!m;(j||W||k)&&(this.activeRun.hasFunctionStreaming=!0);let C=mt(t.data),L=K(t.data.chunk.content),w=!!(!m&&L),b=M&&!(p!=null&&p.toolCallId)&&!w;if(C){this.handleThinkingEvent(C);break}if(!C&&this.thinkingProcess&&(this.dispatchEvent({type:o.EventType.THINKING_TEXT_MESSAGE_END}),this.dispatchEvent({type:o.EventType.THINKING_END}),this.thinkingProcess=null),J&&this.dispatchEvent({type:o.EventType.CUSTOM,name:"PredictState",value:t.metadata.predict_state}),j){this.dispatchEvent({type:o.EventType.TOOL_CALL_END,toolCallId:p==null?void 0:p.toolCallId,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}if(b){this.dispatchEvent({type:o.EventType.TEXT_MESSAGE_END,messageId:p.id,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}if(k&&A){this.dispatchEvent({type:o.EventType.TOOL_CALL_START,toolCallId:m.id,toolCallName:m.name,parentMessageId:t.data.chunk.id,rawEvent:t})&&this.setMessageInProgress(this.activeRun.id,{id:t.data.chunk.id,toolCallId:m.id,toolCallName:m.name});break}if(W&&A){this.dispatchEvent({type:o.EventType.TOOL_CALL_ARGS,toolCallId:p==null?void 0:p.toolCallId,delta:m.args,rawEvent:t});break}if(w&&N){p||(this.dispatchEvent({type:o.EventType.TEXT_MESSAGE_START,role:"assistant",messageId:t.data.chunk.id,rawEvent:t}),this.setMessageInProgress(this.activeRun.id,{id:t.data.chunk.id,toolCallId:null,toolCallName:null}),p=this.getMessageInProgress(this.activeRun.id)),this.dispatchEvent({type:o.EventType.TEXT_MESSAGE_CONTENT,messageId:p.id,delta:L,rawEvent:t});break}break;case"on_chat_model_end":if((u=this.getMessageInProgress(this.activeRun.id))!=null&&u.toolCallId){this.dispatchEvent({type:o.EventType.TOOL_CALL_END,toolCallId:this.getMessageInProgress(this.activeRun.id).toolCallId,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}if((g=this.getMessageInProgress(this.activeRun.id))!=null&&g.id){this.dispatchEvent({type:o.EventType.TEXT_MESSAGE_END,messageId:this.getMessageInProgress(this.activeRun.id).id,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}break;case"on_custom_event":if(t.name==="manually_emit_message"){this.dispatchEvent({type:o.EventType.TEXT_MESSAGE_START,role:"assistant",messageId:t.data.message_id,rawEvent:t}),this.dispatchEvent({type:o.EventType.TEXT_MESSAGE_CONTENT,messageId:t.data.message_id,delta:t.data.message,rawEvent:t}),this.dispatchEvent({type:o.EventType.TEXT_MESSAGE_END,messageId:t.data.message_id,rawEvent:t});break}if(t.name==="manually_emit_tool_call"){this.dispatchEvent({type:o.EventType.TOOL_CALL_START,toolCallId:t.data.id,toolCallName:t.data.name,parentMessageId:t.data.id,rawEvent:t}),this.dispatchEvent({type:o.EventType.TOOL_CALL_ARGS,toolCallId:t.data.id,delta:t.data.args,rawEvent:t}),this.dispatchEvent({type:o.EventType.TOOL_CALL_END,toolCallId:t.data.id,rawEvent:t});break}t.name==="manually_emit_state"&&(this.activeRun.manuallyEmittedState=t.data,this.dispatchEvent({type:o.EventType.STATE_SNAPSHOT,snapshot:this.getStateSnapshot({values:this.activeRun.manuallyEmittedState}),rawEvent:t})),this.dispatchEvent({type:o.EventType.CUSTOM,name:t.name,value:t.data,rawEvent:t});break;case"on_tool_end":let y=(l=t.data)==null?void 0:l.output;if(y&&!y.tool_call_id&&((c=(d=y.update)==null?void 0:d.messages)!=null&&c.find(h=>h.type==="tool"))&&(y=(_=(S=y.update)==null?void 0:S.messages)==null?void 0:_.find(h=>h.type==="tool")),y&&((x=(I=y.update)==null?void 0:I.messages)!=null&&x.length)){(R=y.update)==null||R.messages.filter(h=>h.type==="tool").forEach(h=>{var O;this.activeRun.hasFunctionStreaming||(this.dispatchEvent({type:o.EventType.TOOL_CALL_START,toolCallId:h.tool_call_id,toolCallName:(O=h.name)!=null?O:"",parentMessageId:h.id,rawEvent:t}),this.dispatchEvent({type:o.EventType.TOOL_CALL_ARGS,toolCallId:h.tool_call_id,delta:JSON.stringify(t.data.input),rawEvent:t})),this.dispatchEvent({type:o.EventType.TOOL_CALL_RESULT,toolCallId:h.tool_call_id,content:typeof(h==null?void 0:h.content)=="string"?h==null?void 0:h.content:JSON.stringify(h==null?void 0:h.content),messageId:(0,B.randomUUID)(),rawEvent:t,role:"tool"})});break}this.activeRun.hasFunctionStreaming||(this.dispatchEvent({type:o.EventType.TOOL_CALL_START,toolCallId:y.tool_call_id,toolCallName:y.name,parentMessageId:y.id,rawEvent:t}),this.dispatchEvent({type:o.EventType.TOOL_CALL_ARGS,toolCallId:y.tool_call_id,delta:JSON.stringify(t.data.input),rawEvent:t}),this.dispatchEvent({type:o.EventType.TOOL_CALL_END,toolCallId:y.tool_call_id,rawEvent:t}));let G=Array.isArray(y.content)?y.content.map(h=>typeof h=="string"?h:h.type==="text"?h.text:JSON.stringify(h)).join(""):y.content;this.dispatchEvent({type:o.EventType.TOOL_CALL_RESULT,toolCallId:y.tool_call_id,content:G,messageId:(0,B.randomUUID)(),role:"tool",rawEvent:t});break}}abortRun(){var a,i;this.cancelRequested=!0;let t=(a=this.activeRun)==null?void 0:a.threadId,e=(i=this.activeRun)==null?void 0:i.id;t&&e&&!this.cancelSent&&this.client.runs.cancel(t,e).then(()=>{this.cancelSent=!0}).catch(()=>{}),super.abortRun()}handleThinkingEvent(t){var a;if(!t||!t.type||!t.text)return;let e=t.index;(a=this.thinkingProcess)!=null&&a.index&&this.thinkingProcess.index!==e&&(this.thinkingProcess.type&&this.dispatchEvent({type:o.EventType.THINKING_TEXT_MESSAGE_END}),this.dispatchEvent({type:o.EventType.THINKING_END}),this.thinkingProcess=null),this.thinkingProcess||(this.dispatchEvent({type:o.EventType.THINKING_START}),this.thinkingProcess={index:e}),this.thinkingProcess.type!==t.type&&(this.dispatchEvent({type:o.EventType.THINKING_TEXT_MESSAGE_START}),this.thinkingProcess.type=t.type),this.thinkingProcess.type&&this.dispatchEvent({type:o.EventType.THINKING_TEXT_MESSAGE_CONTENT,delta:t.text})}getStateSnapshot(t){let e=t.values,a=this.activeRun.schemaKeys;return a!=null&&a.output&&(e=Q(e,[...this.constantSchemaKeys,...a.output])),e}async getOrCreateThread(t,e){let a;try{try{a=await this.getThread(t)}catch(i){a=await this.createThread({threadId:t,metadata:e})}}catch(i){throw new Error(`Failed to create thread: ${i.message}`)}return a}async getThread(t){return this.client.threads.get(t)}async createThread(t){return this.client.threads.create(t)}async mergeConfigs({configs:t,assistant:e,schemaKeys:a}){return t.reduce((i,r)=>{var S;let u=i.configurable;r.configurable&&(u=a!=null&&a.config?Q(r==null?void 0:r.configurable,[...this.constantSchemaKeys,...(S=a==null?void 0:a.config)!=null?S:[]]):r==null?void 0:r.configurable);let g=T(f(f({},i),r),{configurable:u}),l=i.recursion_limit==null&&r.recursion_limit===25,d=JSON.stringify(g)!==JSON.stringify(i),c=l&&JSON.stringify(T(f({},g),{recursion_limit:null}))===JSON.stringify(T(f({},i),{recursion_limit:null}));return d&&!c?f(f({},i),g):i},e.config)}getMessageInProgress(t){return this.messagesInProcess[t]}setMessageInProgress(t,e){this.messagesInProcess=T(f({},this.messagesInProcess),{[t]:f(f({},this.messagesInProcess[t]),e)})}async getAssistant(){try{let t=await this.client.assistants.search(),e=t.find(a=>a.graph_id===this.graphId);if(!e){let a=`
      No agent found with graph ID ${this.graphId} found..


      These are the available agents: [${t.map(i=>`${i.graph_id} (ID: ${i.assistant_id})`).join(", ")}]
      `;throw console.error(a),new Error(a)}return e}catch(t){let e=new Error(`Failed to retrieve assistant: ${t.message}`);throw this.dispatchEvent({type:o.EventType.RUN_ERROR,message:e.message}),this.subscriber.error(),e}}async getSchemaKeys(){var t,e,a,i;try{let r=await this.client.assistants.getSchemas(this.assistant.assistant_id),u=null,g=[];if("context_schema"in r&&((t=r.context_schema)!=null&&t.properties)&&(g=Object.keys(r.context_schema.properties)),(e=r.config_schema)!=null&&e.properties&&(u=Object.keys(r.config_schema.properties)),!((a=r.input_schema)!=null&&a.properties)||!((i=r.output_schema)!=null&&i.properties))return{config:[],input:null,output:null,context:g};let l=Object.keys(r.input_schema.properties),d=Object.keys(r.output_schema.properties);return{input:l&&l.length?[...l,...this.constantSchemaKeys]:null,output:d&&d.length?[...d,...this.constantSchemaKeys]:null,context:g,config:u}}catch(r){return{config:[],input:this.constantSchemaKeys,output:this.constantSchemaKeys,context:[]}}}langGraphDefaultMergeState(t,e,a){var l,d;e.length>0&&"role"in e[0]&&e[0].role==="system"&&(e=e.slice(1));let i=t.messages||[],r=new Set(i.map(c=>c.id)),u=e.filter(c=>!r.has(c.id)),g=[...(l=t.tools)!=null?l:[],...(d=a.tools)!=null?d:[]].reduce((c,S)=>{let _=S;return S.type||(_={type:"function",name:S.name,function:{name:S.name,description:S.description,parameters:S.parameters}}),c.find(I=>I.name===_.name||I.function.name===_.function.name)?c:[...c,_]},[]);return T(f({},t),{messages:u,tools:g,"ag-ui":{tools:g,context:a.context}})}handleNodeChange(t){var e,a;t==="__end__"&&(t=void 0),t!==((e=this.activeRun)==null?void 0:e.nodeName)&&((a=this.activeRun)!=null&&a.nodeName&&this.endStep(),t&&this.startStep(t)),this.activeRun.nodeName=t}startStep(t){this.dispatchEvent({type:o.EventType.STEP_STARTED,stepName:t})}endStep(){this.dispatchEvent({type:o.EventType.STEP_FINISHED,stepName:this.activeRun.nodeName})}async getCheckpointByMessage(t,e,a){var R,A;let i=a!=null&&a.checkpoint_id?{checkpoint:{checkpoint_id:a.checkpoint_id}}:void 0,u=[...await this.client.threads.getHistory(e,i)].reverse(),g=u.find(p=>{var M;return(M=p.values.messages)==null?void 0:M.some(m=>m.id===t)});if(!g)throw new Error("Message not found");let l=(R=g.values.messages)!=null?R:[],d=l.findIndex(p=>p.id===t);if(l.slice(d+1).length)return this.getCheckpointByMessage(t,e,g.parent_checkpoint);let S=u.indexOf(g),N=g.values,{messages:_}=N,I=et(N,["messages"]),x=(A=u[S-1])!=null?A:T(f({},g),{values:{}});return T(f({},x),{values:f(f({},x.values),I)})}};var it=class extends St.HttpAgent{};0&&(module.exports={CustomEventNames,LangGraphAgent,LangGraphEventTypes,LangGraphHttpAgent});
//# sourceMappingURL=index.js.map
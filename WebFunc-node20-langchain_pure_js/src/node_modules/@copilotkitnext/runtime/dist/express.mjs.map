{"version":3,"sources":["../src/endpoints/express.ts","../src/endpoints/express-utils.ts","../src/endpoints/express-single.ts"],"sourcesContent":["import express from \"express\";\nimport type { Request as ExpressRequest, Response as ExpressResponse, NextFunction, Router } from \"express\";\nimport cors from \"cors\";\n\nimport { CopilotRuntime } from \"../runtime\";\nimport { handleRunAgent } from \"../handlers/handle-run\";\nimport { handleConnectAgent } from \"../handlers/handle-connect\";\nimport { handleStopAgent } from \"../handlers/handle-stop\";\nimport { handleGetRuntimeInfo } from \"../handlers/get-runtime-info\";\nimport { handleTranscribe } from \"../handlers/handle-transcribe\";\nimport { logger } from \"@copilotkitnext/shared\";\nimport { callBeforeRequestMiddleware, callAfterRequestMiddleware } from \"../middleware\";\nimport { createFetchRequestFromExpress, sendFetchResponse } from \"./express-utils\";\n\ninterface CopilotExpressEndpointParams {\n  runtime: CopilotRuntime;\n  basePath: string;\n}\n\nexport function createCopilotEndpointExpress({ runtime, basePath }: CopilotExpressEndpointParams): Router {\n  const router = express.Router();\n  const normalizedBase = normalizeBasePath(basePath);\n\n  router.use(cors({\n    origin: \"*\",\n    methods: [\"GET\", \"HEAD\", \"PUT\", \"POST\", \"DELETE\", \"PATCH\", \"OPTIONS\"],\n    allowedHeaders: [\"*\"],\n  }));\n\n  router.post(joinPath(normalizedBase, \"/agent/:agentId/run\"), createRouteHandler(runtime, async ({ request, req }) => {\n    const agentId = req.params.agentId as string;\n    return handleRunAgent({ runtime, request, agentId });\n  }));\n\n  router.post(joinPath(normalizedBase, \"/agent/:agentId/connect\"), createRouteHandler(runtime, async ({ request, req }) => {\n    const agentId = req.params.agentId as string;\n    return handleConnectAgent({ runtime, request, agentId });\n  }));\n\n  router.post(joinPath(normalizedBase, \"/agent/:agentId/stop/:threadId\"), createRouteHandler(runtime, async ({ request, req }) => {\n    const agentId = req.params.agentId as string;\n    const threadId = req.params.threadId as string;\n    return handleStopAgent({ runtime, request, agentId, threadId });\n  }));\n\n  router.get(joinPath(normalizedBase, \"/info\"), createRouteHandler(runtime, async ({ request }) => {\n    return handleGetRuntimeInfo({ runtime, request });\n  }));\n\n  router.post(joinPath(normalizedBase, \"/transcribe\"), createRouteHandler(runtime, async ({ request }) => {\n    return handleTranscribe({ runtime, request });\n  }));\n\n  router.use(joinPath(normalizedBase, \"*\"), (req, res) => {\n    res.status(404).json({ error: \"Not found\" });\n  });\n\n  return router;\n}\n\ntype RouteHandlerContext = {\n  request: Request;\n  req: ExpressRequest;\n};\n\ntype RouteHandlerFactory = (ctx: RouteHandlerContext) => Promise<Response>;\n\nfunction createRouteHandler(runtime: CopilotRuntime, factory: RouteHandlerFactory) {\n  return async (req: ExpressRequest, res: ExpressResponse, next: NextFunction) => {\n    const path = req.originalUrl ?? req.path;\n    let request = createFetchRequestFromExpress(req);\n    try {\n      const maybeModifiedRequest = await callBeforeRequestMiddleware({ runtime, request, path });\n      if (maybeModifiedRequest) {\n        request = maybeModifiedRequest;\n      }\n    } catch (error) {\n      logger.error({ err: error, url: request.url, path }, \"Error running before request middleware\");\n      if (error instanceof Response) {\n        try {\n          await sendFetchResponse(res, error);\n        } catch (streamError) {\n          next(streamError);\n        }\n        return;\n      }\n      next(error);\n      return;\n    }\n\n    try {\n      const response = await factory({ request, req });\n      await sendFetchResponse(res, response);\n      callAfterRequestMiddleware({ runtime, response, path }).catch((error) => {\n        logger.error({ err: error, url: req.originalUrl ?? req.url, path }, \"Error running after request middleware\");\n      });\n    } catch (error) {\n      if (error instanceof Response) {\n        try {\n          await sendFetchResponse(res, error);\n        } catch (streamError) {\n          next(streamError);\n          return;\n        }\n        callAfterRequestMiddleware({ runtime, response: error, path }).catch((mwError) => {\n          logger.error({ err: mwError, url: req.originalUrl ?? req.url, path }, \"Error running after request middleware\");\n        });\n        return;\n      }\n      logger.error({ err: error, url: request.url, path }, \"Error running request handler\");\n      next(error);\n    }\n  };\n}\n\nfunction normalizeBasePath(path: string): string {\n  if (!path) {\n    throw new Error(\"basePath must be provided for Express endpoint\");\n  }\n\n  if (!path.startsWith(\"/\")) {\n    return `/${path}`;\n  }\n\n  if (path.length > 1 && path.endsWith(\"/\")) {\n    return path.slice(0, -1);\n  }\n\n  return path;\n}\n\nfunction joinPath(basePath: string, suffix: string): string {\n  if (basePath === \"/\") {\n    return suffix.startsWith(\"/\") ? suffix : `/${suffix}`;\n  }\n\n  if (!suffix) {\n    return basePath;\n  }\n\n  if (suffix === \"*\") {\n    return `${basePath}/*`;\n  }\n\n  return `${basePath}${suffix.startsWith(\"/\") ? suffix : `/${suffix}`}`;\n}\n","import type { Request as ExpressRequest, Response as ExpressResponse } from \"express\";\nimport { Readable } from \"node:stream\";\nimport { pipeline } from \"node:stream\";\nimport { promisify } from \"node:util\";\nimport { logger } from \"@copilotkitnext/shared\";\n\nconst streamPipeline = promisify(pipeline);\n\nconst METHODS_WITHOUT_BODY = new Set([\"GET\", \"HEAD\"]);\n\nexport function createFetchRequestFromExpress(req: ExpressRequest): Request {\n  const method = req.method?.toUpperCase() ?? \"GET\";\n  const origin = buildOrigin(req);\n  const url = `${origin}${req.originalUrl ?? req.url ?? \"\"}`;\n\n  const headers = new Headers();\n  for (const [key, value] of Object.entries(req.headers)) {\n    if (value === undefined) continue;\n    if (Array.isArray(value)) {\n      value.forEach((v) => headers.append(key, v));\n    } else {\n      headers.set(key, value);\n    }\n  }\n\n  const init: RequestInit & { duplex?: \"half\" } = {\n    method,\n    headers,\n  };\n\n  const hasParsedBody = req.body !== undefined && req.body !== null;\n  const streamConsumed = isStreamConsumed(req, hasParsedBody);\n\n  if (!METHODS_WITHOUT_BODY.has(method)) {\n    const canStreamBody = req.readable !== false && !streamConsumed;\n\n    if (canStreamBody) {\n      init.body = Readable.toWeb(req) as unknown as BodyInit;\n      init.duplex = \"half\";\n    } else if (hasParsedBody) {\n      const { body, contentType } = synthesizeBody(req.body);\n      if (contentType) {\n        headers.set(\"content-type\", contentType);\n      }\n      headers.delete(\"content-length\");\n      if (body !== undefined) {\n        init.body = body;\n      }\n      logger.info(\n        {\n          url,\n          method,\n          readable: req.readable,\n          readableEnded: req.readableEnded,\n          complete: req.complete,\n        },\n        \"Express request stream already consumed; synthesized body from parsed content\",\n      );\n    } else {\n      headers.delete(\"content-length\");\n      logger.warn(\n        { url, method },\n        \"Request stream already consumed but no body was available; sending empty body\",\n      );\n    }\n  }\n\n  const controller = new AbortController();\n  const abort = () => controller.abort();\n  req.on(\"aborted\", abort);\n  req.on(\"error\", abort);\n  req.on(\"close\", () => {\n    if (req.aborted) {\n      abort();\n    }\n  });\n  init.signal = controller.signal;\n\n  try {\n    return new Request(url, init);\n  } catch (error) {\n    if (error instanceof TypeError && /disturbed|locked/i.test(error.message)) {\n      // Fallback to synthesized/empty body when the stream was already consumed.\n      headers.delete(\"content-length\");\n      delete init.duplex;\n\n      if (hasParsedBody) {\n        const { body, contentType } = synthesizeBody(req.body);\n        if (contentType) {\n          headers.set(\"content-type\", contentType);\n        }\n        init.body = body;\n        logger.info(\n          { url, method },\n          \"Request stream disturbed while constructing Request; reused parsed body\",\n        );\n      } else {\n        init.body = undefined;\n        logger.warn(\n          { url, method },\n          \"Request stream was disturbed; falling back to empty body\",\n        );\n      }\n\n      return new Request(url, init);\n    }\n    throw error;\n  }\n}\n\nexport async function sendFetchResponse(res: ExpressResponse, response: Response): Promise<void> {\n  res.status(response.status);\n\n  response.headers.forEach((value, key) => {\n    if (key.toLowerCase() === \"content-length\" && response.body !== null) {\n      return;\n    }\n    res.setHeader(key, value);\n  });\n\n  if (!response.body) {\n    res.end();\n    return;\n  }\n\n  const nodeStream = Readable.fromWeb(response.body as any);\n  try {\n    await streamPipeline(nodeStream, res);\n  } catch (error) {\n    res.destroy(error as Error);\n    throw error;\n  }\n}\n\nfunction buildOrigin(req: ExpressRequest): string {\n  const protocol = req.protocol || (req.secure ? \"https\" : \"http\");\n  const host = req.get(\"host\") ?? \"localhost\";\n  return `${protocol}://${host}`;\n}\n\nfunction isStreamConsumed(req: ExpressRequest, hasParsedBody: boolean): boolean {\n  const state = (req as unknown as { _readableState?: { ended?: boolean; endEmitted?: boolean } })\n    ._readableState;\n  return Boolean(\n    hasParsedBody ||\n      req.readableEnded ||\n      req.complete ||\n      state?.ended ||\n      state?.endEmitted,\n  );\n}\n\nfunction synthesizeBody(body: unknown): { body?: BodyInit; contentType?: string } {\n  if (Buffer.isBuffer(body) || body instanceof Uint8Array) {\n    return { body };\n  }\n\n  if (typeof body === \"string\") {\n    return { body };\n  }\n\n  if (typeof body === \"object\" && body !== undefined) {\n    return { body: JSON.stringify(body), contentType: \"application/json\" };\n  }\n\n  return {};\n}\n","import express from \"express\";\nimport type { Request as ExpressRequest, Response as ExpressResponse, NextFunction, Router } from \"express\";\nimport cors from \"cors\";\n\nimport { CopilotRuntime } from \"../runtime\";\nimport { handleRunAgent } from \"../handlers/handle-run\";\nimport { handleConnectAgent } from \"../handlers/handle-connect\";\nimport { handleStopAgent } from \"../handlers/handle-stop\";\nimport { handleGetRuntimeInfo } from \"../handlers/get-runtime-info\";\nimport { handleTranscribe } from \"../handlers/handle-transcribe\";\nimport { logger } from \"@copilotkitnext/shared\";\nimport { callBeforeRequestMiddleware, callAfterRequestMiddleware } from \"../middleware\";\nimport { createFetchRequestFromExpress, sendFetchResponse } from \"./express-utils\";\nimport { createJsonRequest, expectString, MethodCall, parseMethodCall } from \"./single-route-helpers\";\n\ninterface CopilotSingleRouteExpressParams {\n  runtime: CopilotRuntime;\n  basePath: string;\n}\n\nexport function createCopilotEndpointSingleRouteExpress({\n  runtime,\n  basePath,\n}: CopilotSingleRouteExpressParams): Router {\n  const router = express.Router();\n  const routePath = normalizeSingleRoutePath(basePath);\n\n  router.use(cors({\n    origin: \"*\",\n    methods: [\"GET\", \"HEAD\", \"PUT\", \"POST\", \"DELETE\", \"PATCH\", \"OPTIONS\"],\n    allowedHeaders: [\"*\"],\n  }));\n\n  router.post(routePath, createSingleRouteHandler(runtime));\n\n  router.use((req, res) => {\n    res.status(404).json({ error: \"Not found\" });\n  });\n\n  return router;\n}\n\nfunction createSingleRouteHandler(runtime: CopilotRuntime) {\n  return async (req: ExpressRequest, res: ExpressResponse, next: NextFunction) => {\n    const path = req.originalUrl ?? req.path;\n    let request = createFetchRequestFromExpress(req);\n\n    try {\n      const maybeModifiedRequest = await callBeforeRequestMiddleware({ runtime, request, path });\n      if (maybeModifiedRequest) {\n        request = maybeModifiedRequest;\n      }\n    } catch (error) {\n      logger.error({ err: error, url: request.url, path }, \"Error running before request middleware\");\n      if (error instanceof Response) {\n        try {\n          await sendFetchResponse(res, error);\n        } catch (streamError) {\n          next(streamError);\n        }\n        return;\n      }\n      next(error);\n      return;\n    }\n\n    let methodCall: MethodCall;\n    try {\n      methodCall = await parseMethodCall(request);\n    } catch (error) {\n      if (error instanceof Response) {\n        logger.warn({ url: request.url }, \"Invalid single-route payload\");\n        try {\n          await sendFetchResponse(res, error);\n        } catch (streamError) {\n          next(streamError);\n        }\n        return;\n      }\n      logger.warn({ err: error, url: request.url }, \"Invalid single-route payload\");\n      res.status(400).json({\n        error: \"invalid_request\",\n        message: error instanceof Error ? error.message : \"Invalid request payload\",\n      });\n      return;\n    }\n\n    try {\n      let response: Response;\n      switch (methodCall.method) {\n        case \"agent/run\": {\n          const agentId = expectString(methodCall.params, \"agentId\");\n          const handlerRequest = createJsonRequest(request, methodCall.body);\n          response = await handleRunAgent({ runtime, request: handlerRequest, agentId });\n          break;\n        }\n        case \"agent/connect\": {\n          const agentId = expectString(methodCall.params, \"agentId\");\n          const handlerRequest = createJsonRequest(request, methodCall.body);\n          response = await handleConnectAgent({ runtime, request: handlerRequest, agentId });\n          break;\n        }\n        case \"agent/stop\": {\n          const agentId = expectString(methodCall.params, \"agentId\");\n          const threadId = expectString(methodCall.params, \"threadId\");\n          response = await handleStopAgent({ runtime, request, agentId, threadId });\n          break;\n        }\n        case \"info\": {\n          response = await handleGetRuntimeInfo({ runtime, request });\n          break;\n        }\n        case \"transcribe\": {\n          const handlerRequest = createJsonRequest(request, methodCall.body);\n          response = await handleTranscribe({ runtime, request: handlerRequest });\n          break;\n        }\n        default: {\n          const exhaustive: never = methodCall.method;\n          return exhaustive;\n        }\n      }\n\n      await sendFetchResponse(res, response);\n      callAfterRequestMiddleware({ runtime, response, path }).catch((error) => {\n        logger.error({ err: error, url: req.originalUrl ?? req.url, path }, \"Error running after request middleware\");\n      });\n    } catch (error) {\n      if (error instanceof Response) {\n        try {\n          await sendFetchResponse(res, error);\n        } catch (streamError) {\n          next(streamError);\n          return;\n        }\n        callAfterRequestMiddleware({ runtime, response: error, path }).catch((mwError) => {\n          logger.error({ err: mwError, url: req.originalUrl ?? req.url, path }, \"Error running after request middleware\");\n        });\n        return;\n      }\n      logger.error({ err: error, url: request.url, path }, \"Error running single-route handler\");\n      next(error);\n    }\n  };\n}\n\nfunction normalizeSingleRoutePath(path: string): string {\n  if (!path) {\n    throw new Error(\"basePath must be provided for Express single-route endpoint\");\n  }\n\n  if (!path.startsWith(\"/\")) {\n    return `/${path}`;\n  }\n\n  if (path.length > 1 && path.endsWith(\"/\")) {\n    return path.slice(0, -1);\n  }\n\n  return path;\n}\n"],"mappings":"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","names":["logger","logger","express","cors","logger","express","cors","logger"]}
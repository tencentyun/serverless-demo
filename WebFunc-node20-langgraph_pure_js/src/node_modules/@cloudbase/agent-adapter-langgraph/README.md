# @cloudbase/agent-adapter-langgraph

å°† LangGraph å·¥ä½œæµè½¬æ¢ä¸ºç¬¦åˆ [AG-UI åè®®](https://docs.ag-ui.com) çš„ Agentã€‚

## å®‰è£…

```bash
npm install @cloudbase/agent-adapter-langgraph
```

## åŠŸèƒ½

- **LanggraphAgent**ï¼šå°†ç¼–è¯‘åçš„ LangGraph å·¥ä½œæµåŒ…è£…ä¸º AG-UI å…¼å®¹çš„ Agent
- **ClientStateAnnotation**ï¼šå·¥ä½œæµçŠ¶æ€å®šä¹‰ï¼ŒåŒ…å« messages å’Œ client tools

## å¿«é€Ÿå¼€å§‹

### é…åˆ @cloudbase/agent-server ä½¿ç”¨

```typescript
import { run } from "@cloudbase/agent-server";
import { StateGraph, START, END } from "@langchain/langgraph";
import { ClientStateAnnotation, LanggraphAgent } from "@cloudbase/agent-adapter-langgraph";

// åˆ›å»º LangGraph å·¥ä½œæµ
const workflow = new StateGraph(ClientStateAnnotation)
  .addNode("chat_node", chatNode)
  .addEdge(START, "chat_node")
  .addEdge("chat_node", END);

const compiledWorkflow = workflow.compile();

// éƒ¨ç½²ä¸º HTTP æœåŠ¡
run({
  createAgent: () => ({
    agent: new LanggraphAgent({ compiledWorkflow }),
  }),
  port: 9000,
});
```

## API å‚è€ƒ

### LanggraphAgent

å°†ç¼–è¯‘åçš„ LangGraph å·¥ä½œæµè½¬æ¢ä¸º AG-UI å…¼å®¹çš„ Agentã€‚

```typescript
type LanggraphAgentConfig = AgentConfig & {
  compiledWorkflow: CompiledStateGraph; // ç¼–è¯‘åçš„ LangGraph å·¥ä½œæµ
  logger?: Logger;                      // å¯é€‰ï¼Œæ—¥å¿—å®ä¾‹
};

const agent = new LanggraphAgent(config);
```

- `AgentConfig`ï¼šæ¥è‡ª [AG-UI åè®®](https://docs.ag-ui.com)
- `Logger`ï¼šæ—¥å¿—æ¥å£ï¼Œè¯¦è§ [@cloudbase/agent-server æ–‡æ¡£](https://www.npmjs.com/package/@cloudbase/agent-server)

### ClientStateAnnotation

åˆ›å»º LangGraph å·¥ä½œæµæ—¶ä½¿ç”¨çš„çŠ¶æ€å®šä¹‰ï¼Œå·²åŒ…å« AG-UI éœ€è¦çš„å­—æ®µï¼š

- `messages`ï¼šæ¶ˆæ¯å†å²
- `client.tools`ï¼šå®¢æˆ·ç«¯ä¼ æ¥çš„å·¥å…·åˆ—è¡¨

```typescript
const workflow = new StateGraph(ClientStateAnnotation)
  .addNode("chat_node", chatNode)
  // ...
```

## ä½¿ç”¨å®¢æˆ·ç«¯å·¥å…·

AG-UI æ”¯æŒ**å®¢æˆ·ç«¯å·¥å…·**ï¼ˆClient Toolsï¼‰ï¼šå®¢æˆ·ç«¯å®šä¹‰å·¥å…·ï¼ŒAgent è°ƒç”¨åç”±å®¢æˆ·ç«¯æ‰§è¡Œå¹¶è¿”å›ç»“æœã€‚

é€‚ç”¨åœºæ™¯ï¼š
- éœ€è¦è®¿é—®å®¢æˆ·ç«¯ APIï¼ˆå¦‚è·å–åœ°ç†ä½ç½®ã€è®¿é—®å‰ªè´´æ¿ï¼‰
- éœ€è¦ç”¨æˆ·ç¡®è®¤çš„æ“ä½œï¼ˆå¦‚å‘é€é‚®ä»¶å‰ç¡®è®¤ï¼‰
- éœ€è¦å±•ç¤º UI äº¤äº’ï¼ˆå¦‚è®©ç”¨æˆ·é€‰æ‹©æ–‡ä»¶ï¼‰

### åœ¨ chatNode ä¸­ä½¿ç”¨å®¢æˆ·ç«¯å·¥å…·

```typescript
import { ClientState } from "@cloudbase/agent-adapter-langgraph";

async function chatNode(state: ClientState) {
  const model = new ChatOpenAI({ model: "gpt-4o" });

  // åˆå¹¶æœåŠ¡ç«¯å·¥å…·å’Œå®¢æˆ·ç«¯å·¥å…·
  const modelWithTools = model.bindTools([
    ...serverTools,              // æœåŠ¡ç«¯å®šä¹‰çš„å·¥å…·
    ...(state.client?.tools || []) // å®¢æˆ·ç«¯ä¼ æ¥çš„å·¥å…·
  ]);

  const response = await modelWithTools.invoke([...state.messages]);
  return { messages: [response] };
}
```

### åŒºåˆ†æœåŠ¡ç«¯å·¥å…·å’Œå®¢æˆ·ç«¯å·¥å…·

å½“ Agent è°ƒç”¨å·¥å…·æ—¶ï¼Œéœ€è¦åˆ¤æ–­æ˜¯æœåŠ¡ç«¯æ‰§è¡Œè¿˜æ˜¯äº¤ç»™å®¢æˆ·ç«¯ï¼š

```typescript
const serverToolNames = new Set(serverTools.map(t => t.name));

function shouldContinue(state: ClientState): "tools" | "end" {
  const lastMessage = state.messages.at(-1) as AIMessage;

  if (lastMessage.tool_calls?.length) {
    // å¦‚æœæ˜¯æœåŠ¡ç«¯å·¥å…·ï¼Œç»§ç»­æ‰§è¡Œ
    const hasServerTool = lastMessage.tool_calls.some(
      tc => serverToolNames.has(tc.name)
    );
    if (hasServerTool) return "tools";
  }

  // å®¢æˆ·ç«¯å·¥å…·æˆ–æ— å·¥å…·è°ƒç”¨ï¼Œç»“æŸå¹¶è¿”å›ç»™å®¢æˆ·ç«¯
  return "end";
}
``` 

## ä¾èµ–

- `@langchain/langgraph`ï¼šLangGraph æ¡†æ¶
- `@langchain/core`ï¼šLangChain æ ¸å¿ƒå·¥å…·

## æ–‡æ¡£

ğŸ“š å®Œæ•´æ–‡æ¡£è¯·å‚é˜… [äº‘å¼€å‘ Agent å¼€å‘æŒ‡å—](https://docs.cloudbase.net/ai/agent-development/)

## ç›¸å…³èµ„æº

- [AG-UI åè®®](https://docs.ag-ui.com)
- [LangGraph æ–‡æ¡£](https://langchain-ai.github.io/langgraph/)

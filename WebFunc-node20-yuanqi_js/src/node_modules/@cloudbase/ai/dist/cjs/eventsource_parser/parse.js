"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createParser = void 0;
function createParser(onParse) {
    var isFirstChunk;
    var buffer;
    var startingPosition;
    var startingFieldLength;
    var eventId;
    var eventName;
    var data;
    reset();
    return { feed: feed, reset: reset };
    function reset() {
        isFirstChunk = true;
        buffer = '';
        startingPosition = 0;
        startingFieldLength = -1;
        eventId = undefined;
        eventName = undefined;
        data = '';
    }
    function feed(chunk) {
        buffer = buffer ? buffer + chunk : chunk;
        if (isFirstChunk && hasBom(buffer)) {
            buffer = buffer.slice(BOM.length);
        }
        isFirstChunk = false;
        var length = buffer.length;
        var position = 0;
        var discardTrailingNewline = false;
        while (position < length) {
            if (discardTrailingNewline) {
                if (buffer[position] === '\n') {
                    position += 1;
                }
                discardTrailingNewline = false;
            }
            var lineLength = -1;
            var fieldLength = startingFieldLength;
            var character = void 0;
            for (var index = startingPosition; lineLength < 0 && index < length; index++) {
                character = buffer[index];
                if (character === ':' && fieldLength < 0) {
                    fieldLength = index - position;
                }
                else if (character === '\r') {
                    discardTrailingNewline = true;
                    lineLength = index - position;
                }
                else if (character === '\n') {
                    lineLength = index - position;
                }
            }
            if (lineLength < 0) {
                startingPosition = length - position;
                startingFieldLength = fieldLength;
                break;
            }
            else {
                startingPosition = 0;
                startingFieldLength = -1;
            }
            parseEventStreamLine(buffer, position, fieldLength, lineLength);
            position += lineLength + 1;
        }
        if (position === length) {
            buffer = '';
        }
        else if (position > 0) {
            buffer = buffer.slice(position);
        }
    }
    function parseEventStreamLine(lineBuffer, index, fieldLength, lineLength) {
        if (lineLength === 0) {
            if (data.length > 0) {
                onParse({
                    type: 'event',
                    id: eventId,
                    event: eventName || undefined,
                    data: data.slice(0, -1),
                });
                data = '';
                eventId = undefined;
            }
            eventName = undefined;
            return;
        }
        var noValue = fieldLength < 0;
        var field = lineBuffer.slice(index, index + (noValue ? lineLength : fieldLength));
        var step = 0;
        if (noValue) {
            step = lineLength;
        }
        else if (lineBuffer[index + fieldLength + 1] === ' ') {
            step = fieldLength + 2;
        }
        else {
            step = fieldLength + 1;
        }
        var position = index + step;
        var valueLength = lineLength - step;
        var value = lineBuffer.slice(position, position + valueLength).toString();
        if (field === 'data') {
            data += value ? "".concat(value, "\n") : '\n';
        }
        else if (field === 'event') {
            eventName = value;
        }
        else if (field === 'id' && !value.includes('\u0000')) {
            eventId = value;
        }
        else if (field === 'retry') {
            var retry = parseInt(value, 10);
            if (!Number.isNaN(retry)) {
                onParse({ type: 'reconnect-interval', value: retry });
            }
        }
    }
}
exports.createParser = createParser;
var BOM = [239, 187, 191];
function hasBom(buffer) {
    return BOM.every(function (charCode, index) { return buffer.charCodeAt(index) === charCode; });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvZXZlbnRzb3VyY2VfcGFyc2VyL3BhcnNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQWtCQSxTQUFnQixZQUFZLENBQUMsT0FBaUM7SUFFNUQsSUFBSSxZQUFxQixDQUFBO0lBQ3pCLElBQUksTUFBYyxDQUFBO0lBQ2xCLElBQUksZ0JBQXdCLENBQUE7SUFDNUIsSUFBSSxtQkFBMkIsQ0FBQTtJQUcvQixJQUFJLE9BQTJCLENBQUE7SUFDL0IsSUFBSSxTQUE2QixDQUFBO0lBQ2pDLElBQUksSUFBWSxDQUFBO0lBRWhCLEtBQUssRUFBRSxDQUFBO0lBQ1AsT0FBTyxFQUFFLElBQUksTUFBQSxFQUFFLEtBQUssT0FBQSxFQUFFLENBQUE7SUFFdEIsU0FBUyxLQUFLO1FBQ1osWUFBWSxHQUFHLElBQUksQ0FBQTtRQUNuQixNQUFNLEdBQUcsRUFBRSxDQUFBO1FBQ1gsZ0JBQWdCLEdBQUcsQ0FBQyxDQUFBO1FBQ3BCLG1CQUFtQixHQUFHLENBQUMsQ0FBQyxDQUFBO1FBRXhCLE9BQU8sR0FBRyxTQUFTLENBQUE7UUFDbkIsU0FBUyxHQUFHLFNBQVMsQ0FBQTtRQUNyQixJQUFJLEdBQUcsRUFBRSxDQUFBO0lBQ1gsQ0FBQztJQUVELFNBQVMsSUFBSSxDQUFDLEtBQWE7UUFDekIsTUFBTSxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFBO1FBS3hDLElBQUksWUFBWSxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUNsQyxNQUFNLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUE7U0FDbEM7UUFFRCxZQUFZLEdBQUcsS0FBSyxDQUFBO1FBR1osSUFBQSxNQUFNLEdBQUssTUFBTSxPQUFYLENBQVc7UUFDekIsSUFBSSxRQUFRLEdBQUcsQ0FBQyxDQUFB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RSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUE7QUFFM0IsU0FBUyxNQUFNLENBQUMsTUFBYztJQUM1QixPQUFPLEdBQUcsQ0FBQyxLQUFLLENBQUMsVUFBQyxRQUFnQixFQUFFLEtBQWEsSUFBSyxPQUFBLE1BQU0sQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLEtBQUssUUFBUSxFQUFyQyxDQUFxQyxDQUFDLENBQUE7QUFDOUYsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogRXZlbnRTb3VyY2UvU2VydmVyLVNlbnQgRXZlbnRzIHBhcnNlclxuICogQHNlZSBodHRwczovL2h0bWwuc3BlYy53aGF0d2cub3JnL211bHRpcGFnZS9zZXJ2ZXItc2VudC1ldmVudHMuaHRtbFxuICpcbiAqIEJhc2VkIG9uIGNvZGUgZnJvbSB0aGUge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9FdmVudFNvdXJjZS9ldmVudHNvdXJjZSB8IEV2ZW50U291cmNlIG1vZHVsZX0sXG4gKiB3aGljaCBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuIEFuZCBjb3B5cmlnaHRlZCB0aGUgRXZlbnRTb3VyY2UgR2l0SHViIG9yZ2FuaXNhdGlvbi5cbiAqL1xuaW1wb3J0IHR5cGUgeyBFdmVudFNvdXJjZVBhcnNlQ2FsbGJhY2ssIEV2ZW50U291cmNlUGFyc2VyIH0gZnJvbSAnLi90eXBlcydcblxuLyoqXG4gKiBDcmVhdGVzIGEgbmV3IEV2ZW50U291cmNlIHBhcnNlci5cbiAqXG4gKiBAcGFyYW0gb25QYXJzZSAtIENhbGxiYWNrIHRvIGludm9rZSB3aGVuIGEgbmV3IGV2ZW50IGlzIHBhcnNlZCwgb3IgYSBuZXcgcmVjb25uZWN0aW9uIGludGVydmFsXG4gKiAgICAgICAgICAgICAgICAgIGhhcyBiZWVuIHNlbnQgZnJvbSB0aGUgc2VydmVyXG4gKlxuICogQHJldHVybnMgQSBuZXcgRXZlbnRTb3VyY2UgcGFyc2VyLCB3aXRoIGBwYXJzZWAgYW5kIGByZXNldGAgbWV0aG9kcy5cbiAqIEBwdWJsaWNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVBhcnNlcihvblBhcnNlOiBFdmVudFNvdXJjZVBhcnNlQ2FsbGJhY2spOiBFdmVudFNvdXJjZVBhcnNlciB7XG4gIC8vIFByb2Nlc3Npbmcgc3RhdGVcbiAgbGV0IGlzRmlyc3RDaHVuazogYm9vbGVhblxuICBsZXQgYnVmZmVyOiBzdHJpbmdcbiAgbGV0IHN0YXJ0aW5nUG9zaXRpb246IG51bWJlclxuICBsZXQgc3RhcnRpbmdGaWVsZExlbmd0aDogbnVtYmVyXG5cbiAgLy8gRXZlbnQgc3RhdGVcbiAgbGV0IGV2ZW50SWQ6IHN0cmluZyB8IHVuZGVmaW5lZFxuICBsZXQgZXZlbnROYW1lOiBzdHJpbmcgfCB1bmRlZmluZWRcbiAgbGV0IGRhdGE6IHN0cmluZ1xuXG4gIHJlc2V0KClcbiAgcmV0dXJuIHsgZmVlZCwgcmVzZXQgfVxuXG4gIGZ1bmN0aW9uIHJlc2V0KCk6IHZvaWQge1xuICAgIGlzRmlyc3RDaHVuayA9IHRydWVcbiAgICBidWZmZXIgPSAnJ1xuICAgIHN0YXJ0aW5nUG9zaXRpb24gPSAwXG4gICAgc3RhcnRpbmdGaWVsZExlbmd0aCA9IC0xXG5cbiAgICBldmVudElkID0gdW5kZWZpbmVkXG4gICAgZXZlbnROYW1lID0gdW5kZWZpbmVkXG4gICAgZGF0YSA9ICcnXG4gIH1cblxuICBmdW5jdGlvbiBmZWVkKGNodW5rOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBidWZmZXIgPSBidWZmZXIgPyBidWZmZXIgKyBjaHVuayA6IGNodW5rXG5cbiAgICAvLyBTdHJpcCBhbnkgVVRGOCBieXRlIG9yZGVyIG1hcmsgKEJPTSkgYXQgdGhlIHN0YXJ0IG9mIHRoZSBzdHJlYW0uXG4gICAgLy8gTm90ZSB0aGF0IHdlIGRvIG5vdCBzdHJpcCBhbnkgbm9uIC0gVVRGOCBCT00sIGFzIGV2ZW50c291cmNlIHN0cmVhbXMgYXJlXG4gICAgLy8gYWx3YXlzIGRlY29kZWQgYXMgVVRGOCBhcyBwZXIgdGhlIHNwZWNpZmljYXRpb24uXG4gICAgaWYgKGlzRmlyc3RDaHVuayAmJiBoYXNCb20oYnVmZmVyKSkge1xuICAgICAgYnVmZmVyID0gYnVmZmVyLnNsaWNlKEJPTS5sZW5ndGgpXG4gICAgfVxuXG4gICAgaXNGaXJzdENodW5rID0gZmFsc2VcblxuICAgIC8vIFNldCB1cCBjaHVuay1zcGVjaWZpYyBwcm9jZXNzaW5nIHN0YXRlXG4gICAgY29uc3QgeyBsZW5ndGggfSA9IGJ1ZmZlclxuICAgIGxldCBwb3NpdGlvbiA9IDBcbiAgICBsZXQgZGlzY2FyZFRyYWlsaW5nTmV3bGluZSA9IGZhbHNlXG5cbiAgICAvLyBSZWFkIHRoZSBjdXJyZW50IGJ1ZmZlciBieXRlIGJ5IGJ5dGVcbiAgICB3aGlsZSAocG9zaXRpb24gPCBsZW5ndGgpIHtcbiAgICAgIC8vIEV2ZW50U291cmNlIGFsbG93cyBmb3IgY2FycmlhZ2UgcmV0dXJuICsgbGluZSBmZWVkLCB3aGljaCBtZWFucyB3ZVxuICAgICAgLy8gbmVlZCB0byBpZ25vcmUgYSBsaW5lZmVlZCBjaGFyYWN0ZXIgaWYgdGhlIHByZXZpb3VzIGNoYXJhY3RlciB3YXMgYVxuICAgICAgLy8gY2FycmlhZ2UgcmV0dXJuXG4gICAgICAvLyBAdG9kbyByZWZhY3RvciB0byByZWR1Y2UgbmVzdGluZywgY29uc2lkZXIgY2hlY2tpbmcgcHJldmlvdXMgYnl0ZT9cbiAgICAgIC8vIEB0b2RvIGJ1dCBjb25zaWRlciBtdWx0aXBsZSBjaHVua3MgZXRjXG4gICAgICBpZiAoZGlzY2FyZFRyYWlsaW5nTmV3bGluZSkge1xuICAgICAgICBpZiAoYnVmZmVyW3Bvc2l0aW9uXSA9PT0gJ1xcbicpIHtcbiAgICAgICAgICBwb3NpdGlvbiArPSAxXG4gICAgICAgIH1cbiAgICAgICAgZGlzY2FyZFRyYWlsaW5nTmV3bGluZSA9IGZhbHNlXG4gICAgICB9XG5cbiAgICAgIGxldCBsaW5lTGVuZ3RoID0gLTFcbiAgICAgIGxldCBmaWVsZExlbmd0aCA9IHN0YXJ0aW5nRmllbGRMZW5ndGhcbiAgICAgIGxldCBjaGFyYWN0ZXI6IHN0cmluZ1xuXG4gICAgICBmb3IgKGxldCBpbmRleCA9IHN0YXJ0aW5nUG9zaXRpb247IGxpbmVMZW5ndGggPCAwICYmIGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgIGNoYXJhY3RlciA9IGJ1ZmZlcltpbmRleF1cbiAgICAgICAgaWYgKGNoYXJhY3RlciA9PT0gJzonICYmIGZpZWxkTGVuZ3RoIDwgMCkge1xuICAgICAgICAgIGZpZWxkTGVuZ3RoID0gaW5kZXggLSBwb3NpdGlvblxuICAgICAgICB9IGVsc2UgaWYgKGNoYXJhY3RlciA9PT0gJ1xccicpIHtcbiAgICAgICAgICBkaXNjYXJkVHJhaWxpbmdOZXdsaW5lID0gdHJ1ZVxuICAgICAgICAgIGxpbmVMZW5ndGggPSBpbmRleCAtIHBvc2l0aW9uXG4gICAgICAgIH0gZWxzZSBpZiAoY2hhcmFjdGVyID09PSAnXFxuJykge1xuICAgICAgICAgIGxpbmVMZW5ndGggPSBpbmRleCAtIHBvc2l0aW9uXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKGxpbmVMZW5ndGggPCAwKSB7XG4gICAgICAgIHN0YXJ0aW5nUG9zaXRpb24gPSBsZW5ndGggLSBwb3NpdGlvblxuICAgICAgICBzdGFydGluZ0ZpZWxkTGVuZ3RoID0gZmllbGRMZW5ndGhcbiAgICAgICAgYnJlYWtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHN0YXJ0aW5nUG9zaXRpb24gPSAwXG4gICAgICAgIHN0YXJ0aW5nRmllbGRMZW5ndGggPSAtMVxuICAgICAgfVxuXG4gICAgICBwYXJzZUV2ZW50U3RyZWFtTGluZShidWZmZXIsIHBvc2l0aW9uLCBmaWVsZExlbmd0aCwgbGluZUxlbmd0aClcblxuICAgICAgcG9zaXRpb24gKz0gbGluZUxlbmd0aCArIDFcbiAgICB9XG5cbiAgICBpZiAocG9zaXRpb24gPT09IGxlbmd0aCkge1xuICAgICAgLy8gSWYgd2UgY29uc3VtZWQgdGhlIGVudGlyZSBidWZmZXIgdG8gcmVhZCB0aGUgZXZlbnQsIHJlc2V0IHRoZSBidWZmZXJcbiAgICAgIGJ1ZmZlciA9ICcnXG4gICAgfSBlbHNlIGlmIChwb3NpdGlvbiA+IDApIHtcbiAgICAgIC8vIElmIHRoZXJlIGFyZSBieXRlcyBsZWZ0IHRvIHByb2Nlc3MsIHNldCB0aGUgYnVmZmVyIHRvIHRoZSB1bnByb2Nlc3NlZFxuICAgICAgLy8gcG9ydGlvbiBvZiB0aGUgYnVmZmVyIG9ubHlcbiAgICAgIGJ1ZmZlciA9IGJ1ZmZlci5zbGljZShwb3NpdGlvbilcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBwYXJzZUV2ZW50U3RyZWFtTGluZShsaW5lQnVmZmVyOiBzdHJpbmcsIGluZGV4OiBudW1iZXIsIGZpZWxkTGVuZ3RoOiBudW1iZXIsIGxpbmVMZW5ndGg6IG51bWJlcikge1xuICAgIGlmIChsaW5lTGVuZ3RoID09PSAwKSB7XG4gICAgICAvLyBXZSByZWFjaGVkIHRoZSBsYXN0IGxpbmUgb2YgdGhpcyBldmVudFxuICAgICAgaWYgKGRhdGEubGVuZ3RoID4gMCkge1xuICAgICAgICBvblBhcnNlKHtcbiAgICAgICAgICB0eXBlOiAnZXZlbnQnLFxuICAgICAgICAgIGlkOiBldmVudElkLFxuICAgICAgICAgIGV2ZW50OiBldmVudE5hbWUgfHwgdW5kZWZpbmVkLFxuICAgICAgICAgIGRhdGE6IGRhdGEuc2xpY2UoMCwgLTEpLCAvLyByZW1vdmUgdHJhaWxpbmcgbmV3bGluZVxuICAgICAgICB9KVxuXG4gICAgICAgIGRhdGEgPSAnJ1xuICAgICAgICBldmVudElkID0gdW5kZWZpbmVkXG4gICAgICB9XG4gICAgICBldmVudE5hbWUgPSB1bmRlZmluZWRcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGNvbnN0IG5vVmFsdWUgPSBmaWVsZExlbmd0aCA8IDBcbiAgICBjb25zdCBmaWVsZCA9IGxpbmVCdWZmZXIuc2xpY2UoaW5kZXgsIGluZGV4ICsgKG5vVmFsdWUgPyBsaW5lTGVuZ3RoIDogZmllbGRMZW5ndGgpKVxuICAgIGxldCBzdGVwID0gMFxuXG4gICAgaWYgKG5vVmFsdWUpIHtcbiAgICAgIHN0ZXAgPSBsaW5lTGVuZ3RoXG4gICAgfSBlbHNlIGlmIChsaW5lQnVmZmVyW2luZGV4ICsgZmllbGRMZW5ndGggKyAxXSA9PT0gJyAnKSB7XG4gICAgICBzdGVwID0gZmllbGRMZW5ndGggKyAyXG4gICAgfSBlbHNlIHtcbiAgICAgIHN0ZXAgPSBmaWVsZExlbmd0aCArIDFcbiAgICB9XG5cbiAgICBjb25zdCBwb3NpdGlvbiA9IGluZGV4ICsgc3RlcFxuICAgIGNvbnN0IHZhbHVlTGVuZ3RoID0gbGluZUxlbmd0aCAtIHN0ZXBcbiAgICBjb25zdCB2YWx1ZSA9IGxpbmVCdWZmZXIuc2xpY2UocG9zaXRpb24sIHBvc2l0aW9uICsgdmFsdWVMZW5ndGgpLnRvU3RyaW5nKClcblxuICAgIGlmIChmaWVsZCA9PT0gJ2RhdGEnKSB7XG4gICAgICBkYXRhICs9IHZhbHVlID8gYCR7dmFsdWV9XFxuYCA6ICdcXG4nXG4gICAgfSBlbHNlIGlmIChmaWVsZCA9PT0gJ2V2ZW50Jykge1xuICAgICAgZXZlbnROYW1lID0gdmFsdWVcbiAgICB9IGVsc2UgaWYgKGZpZWxkID09PSAnaWQnICYmICF2YWx1ZS5pbmNsdWRlcygnXFx1MDAwMCcpKSB7XG4gICAgICBldmVudElkID0gdmFsdWVcbiAgICB9IGVsc2UgaWYgKGZpZWxkID09PSAncmV0cnknKSB7XG4gICAgICBjb25zdCByZXRyeSA9IHBhcnNlSW50KHZhbHVlLCAxMClcbiAgICAgIGlmICghTnVtYmVyLmlzTmFOKHJldHJ5KSkge1xuICAgICAgICBvblBhcnNlKHsgdHlwZTogJ3JlY29ubmVjdC1pbnRlcnZhbCcsIHZhbHVlOiByZXRyeSB9KVxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5jb25zdCBCT00gPSBbMjM5LCAxODcsIDE5MV1cblxuZnVuY3Rpb24gaGFzQm9tKGJ1ZmZlcjogc3RyaW5nKSB7XG4gIHJldHVybiBCT00uZXZlcnkoKGNoYXJDb2RlOiBudW1iZXIsIGluZGV4OiBudW1iZXIpID0+IGJ1ZmZlci5jaGFyQ29kZUF0KGluZGV4KSA9PT0gY2hhckNvZGUpXG59XG4iXX0=
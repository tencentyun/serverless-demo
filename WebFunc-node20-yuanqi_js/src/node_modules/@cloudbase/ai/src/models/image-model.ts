import type {
  ModelReq,
  // ImageEditInput,
  HunyuanGenerateImageInput,
  HunyuanGenerateImageOutput,
  HunyuanARGenerateImageInput,
  HunyuanARGenerateImageOutput,
  // HunyuanEditImageInput,
  // HunyuanEditImageOutput,
} from '../type'

interface HunyuanImageGenerateFn {
  (input: HunyuanARGenerateImageInput): Promise<HunyuanARGenerateImageOutput>
  (input: HunyuanGenerateImageInput): Promise<HunyuanGenerateImageOutput>
}

type GenerateImageFn<TProvider> = TProvider extends 'hunyuan-image'
  ? HunyuanImageGenerateFn
  : (input: unknown) => Promise<unknown>

export class DefaultImageModel<TProvider extends string> {
  public defaultGenerateImageSubUrl = 'images/generations'

  public generateImageSubUrlConfig: Record<string, Record<string, string>> = {
    'hunyuan-image': {
      'hunyuan-image-v3.0-v1.0.4': 'images/ar/generations',
      'hunyuan-image-v3.0-v1.0.1': 'images/ar/generations',
    },
  }

  /** 生成图片 */
  public generateImage: GenerateImageFn<TProvider>

  constructor(private req: ModelReq, public baseUrl: string, public provider: TProvider) {
    this.generateImage = this.generateImageImpl.bind(this) as GenerateImageFn<TProvider>
  }

  /** generateImage 的实际实现 */
  private async generateImageImpl(input: HunyuanARGenerateImageInput | HunyuanGenerateImageInput,): Promise<HunyuanARGenerateImageOutput | HunyuanGenerateImageOutput> {
    let subUrl = this.defaultGenerateImageSubUrl

    if (typeof input === 'object' && input && 'model' in input && typeof input.model === 'string') {
      const newSubUrl = this.generateImageSubUrlConfig[this.provider]?.[input.model]
      if (newSubUrl) subUrl = newSubUrl
    }

    const res = (await this.req({
      url: this.getGenerateUrl(subUrl),
      data: input,
      stream: false,
    })) as HunyuanARGenerateImageOutput | HunyuanGenerateImageOutput

    return res
  }

  private getGenerateUrl(subUrl: string) {
    return `${this.baseUrl}/${this.provider}/${subUrl}`
  }
}

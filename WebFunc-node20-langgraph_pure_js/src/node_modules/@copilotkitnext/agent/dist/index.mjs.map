{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import {\n  AbstractAgent,\n  BaseEvent,\n  RunAgentInput,\n  EventType,\n  Message,\n  RunFinishedEvent,\n  RunStartedEvent,\n  TextMessageChunkEvent,\n  ToolCallArgsEvent,\n  ToolCallEndEvent,\n  ToolCallStartEvent,\n  ToolCallResultEvent,\n  RunErrorEvent,\n  StateSnapshotEvent,\n  StateDeltaEvent,\n} from \"@ag-ui/client\";\nimport {\n  streamText,\n  LanguageModel,\n  ModelMessage,\n  AssistantModelMessage,\n  UserModelMessage,\n  ToolModelMessage,\n  SystemModelMessage,\n  ToolCallPart,\n  ToolResultPart,\n  TextPart,\n  tool as createVercelAISDKTool,\n  ToolChoice,\n  ToolSet,\n  stepCountIs,\n} from \"ai\";\nimport { experimental_createMCPClient as createMCPClient } from \"@ai-sdk/mcp\";\nimport { Observable } from \"rxjs\";\nimport { createOpenAI } from \"@ai-sdk/openai\";\nimport { createAnthropic } from \"@ai-sdk/anthropic\";\nimport { createGoogleGenerativeAI } from \"@ai-sdk/google\";\nimport { randomUUID } from \"crypto\";\nimport { z } from \"zod\";\nimport {\n  StreamableHTTPClientTransport,\n  StreamableHTTPClientTransportOptions,\n} from \"@modelcontextprotocol/sdk/client/streamableHttp.js\";\nimport { SSEClientTransport } from \"@modelcontextprotocol/sdk/client/sse.js\";\n\n/**\n * Properties that can be overridden by forwardedProps\n * These match the exact parameter names in streamText\n */\nexport type OverridableProperty =\n  | \"model\"\n  | \"toolChoice\"\n  | \"maxOutputTokens\"\n  | \"temperature\"\n  | \"topP\"\n  | \"topK\"\n  | \"presencePenalty\"\n  | \"frequencyPenalty\"\n  | \"stopSequences\"\n  | \"seed\"\n  | \"maxRetries\"\n  | \"prompt\";\n\n/**\n * Supported model identifiers for BuiltInAgent\n */\nexport type BuiltInAgentModel =\n  // OpenAI models\n  | \"openai/gpt-5\"\n  | \"openai/gpt-5-mini\"\n  | \"openai/gpt-4.1\"\n  | \"openai/gpt-4.1-mini\"\n  | \"openai/gpt-4.1-nano\"\n  | \"openai/gpt-4o\"\n  | \"openai/gpt-4o-mini\"\n  // OpenAI reasoning series\n  | \"openai/o3\"\n  | \"openai/o3-mini\"\n  | \"openai/o4-mini\"\n  // Anthropic (Claude) models\n  | \"anthropic/claude-sonnet-4.5\"\n  | \"anthropic/claude-sonnet-4\"\n  | \"anthropic/claude-3.7-sonnet\"\n  | \"anthropic/claude-opus-4.1\"\n  | \"anthropic/claude-opus-4\"\n  | \"anthropic/claude-3.5-haiku\"\n  // Google (Gemini) models\n  | \"google/gemini-2.5-pro\"\n  | \"google/gemini-2.5-flash\"\n  | \"google/gemini-2.5-flash-lite\"\n  // Allow any LanguageModel instance\n  | (string & {});\n\n/**\n * Model specifier - can be a string like \"openai/gpt-4o\" or a LanguageModel instance\n */\nexport type ModelSpecifier = string | LanguageModel;\n\n/**\n * MCP Client configuration for HTTP transport\n */\nexport interface MCPClientConfigHTTP {\n  /**\n   * Type of MCP client\n   */\n  type: \"http\";\n  /**\n   * URL of the MCP server\n   */\n  url: string;\n  /**\n   * Optional transport options for HTTP client\n   */\n  options?: StreamableHTTPClientTransportOptions;\n}\n\n/**\n * MCP Client configuration for SSE transport\n */\nexport interface MCPClientConfigSSE {\n  /**\n   * Type of MCP client\n   */\n  type: \"sse\";\n  /**\n   * URL of the MCP server\n   */\n  url: string;\n  /**\n   * Optional HTTP headers (e.g., for authentication)\n   */\n  headers?: Record<string, string>;\n}\n\n/**\n * MCP Client configuration\n */\nexport type MCPClientConfig = MCPClientConfigHTTP | MCPClientConfigSSE;\n\n/**\n * Resolves a model specifier to a LanguageModel instance\n * @param spec - Model string (e.g., \"openai/gpt-4o\") or LanguageModel instance\n * @param apiKey - Optional API key to use instead of environment variables\n * @returns LanguageModel instance\n */\nexport function resolveModel(spec: ModelSpecifier, apiKey?: string): LanguageModel {\n  // If already a LanguageModel instance, pass through\n  if (typeof spec !== \"string\") {\n    return spec;\n  }\n\n  // Normalize \"provider/model\" or \"provider:model\" format\n  const normalized = spec.replace(\"/\", \":\").trim();\n  const parts = normalized.split(\":\");\n  const rawProvider = parts[0];\n  const rest = parts.slice(1);\n\n  if (!rawProvider) {\n    throw new Error(\n      `Invalid model string \"${spec}\". Use \"openai/gpt-5\", \"anthropic/claude-sonnet-4.5\", or \"google/gemini-2.5-pro\".`,\n    );\n  }\n\n  const provider = rawProvider.toLowerCase();\n  const model = rest.join(\":\").trim();\n\n  if (!model) {\n    throw new Error(\n      `Invalid model string \"${spec}\". Use \"openai/gpt-5\", \"anthropic/claude-sonnet-4.5\", or \"google/gemini-2.5-pro\".`,\n    );\n  }\n\n  switch (provider) {\n    case \"openai\": {\n      // Lazily create OpenAI provider\n      // Use provided apiKey, or fall back to environment variable\n      const openai = createOpenAI({\n        apiKey: apiKey || process.env.OPENAI_API_KEY!,\n      });\n      // Accepts any OpenAI model id, e.g. \"gpt-4o\", \"gpt-4.1-mini\", \"o3-mini\"\n      return openai(model);\n    }\n\n    case \"anthropic\": {\n      // Lazily create Anthropic provider\n      // Use provided apiKey, or fall back to environment variable\n      const anthropic = createAnthropic({\n        apiKey: apiKey || process.env.ANTHROPIC_API_KEY!,\n      });\n      // Accepts any Claude id, e.g. \"claude-3.7-sonnet\", \"claude-3.5-haiku\"\n      return anthropic(model);\n    }\n\n    case \"google\":\n    case \"gemini\":\n    case \"google-gemini\": {\n      // Lazily create Google provider\n      // Use provided apiKey, or fall back to environment variable\n      const google = createGoogleGenerativeAI({\n        apiKey: apiKey || process.env.GOOGLE_API_KEY!,\n      });\n      // Accepts any Gemini id, e.g. \"gemini-2.5-pro\", \"gemini-2.5-flash\"\n      return google(model);\n    }\n\n    default:\n      throw new Error(`Unknown provider \"${provider}\" in \"${spec}\". Supported: openai, anthropic, google (gemini).`);\n  }\n}\n\n/**\n * Tool definition for BuiltInAgent\n */\nexport interface ToolDefinition<TParameters extends z.ZodTypeAny = z.ZodTypeAny> {\n  name: string;\n  description: string;\n  parameters: TParameters;\n  execute: (args: z.infer<TParameters>) => Promise<unknown>;\n}\n\n/**\n * Define a tool for use with BuiltInAgent\n * @param name - The name of the tool\n * @param description - Description of what the tool does\n * @param parameters - Zod schema for the tool's input parameters\n * @param execute - Function to execute the tool server-side\n * @returns Tool definition\n */\nexport function defineTool<TParameters extends z.ZodTypeAny>(config: {\n  name: string;\n  description: string;\n  parameters: TParameters;\n  execute: (args: z.infer<TParameters>) => Promise<unknown>;\n}): ToolDefinition<TParameters> {\n  return {\n    name: config.name,\n    description: config.description,\n    parameters: config.parameters,\n    execute: config.execute,\n  };\n}\n\ntype AGUIUserMessage = Extract<Message, { role: \"user\" }>;\n\nfunction flattenUserMessageContent(content?: AGUIUserMessage[\"content\"]): string {\n  if (!content) {\n    return \"\";\n  }\n\n  if (typeof content === \"string\") {\n    return content;\n  }\n\n  return content\n    .map((part) => {\n      if (\n        part &&\n        typeof part === \"object\" &&\n        \"type\" in part &&\n        (part as { type?: unknown }).type === \"text\" &&\n        typeof (part as { text?: unknown }).text === \"string\"\n      ) {\n        return (part as { text: string }).text;\n      }\n      return \"\";\n    })\n    .filter((text) => text.length > 0)\n    .join(\"\\n\");\n}\n\n/**\n * Options for converting AG-UI messages to Vercel AI SDK format\n */\nexport interface MessageConversionOptions {\n  forwardSystemMessages?: boolean;\n  forwardDeveloperMessages?: boolean;\n}\n\n/**\n * Converts AG-UI messages to Vercel AI SDK ModelMessage format\n */\nexport function convertMessagesToVercelAISDKMessages(\n  messages: Message[],\n  options: MessageConversionOptions = {},\n): ModelMessage[] {\n  const result: ModelMessage[] = [];\n\n  for (const message of messages) {\n    if (message.role === \"system\" && options.forwardSystemMessages) {\n      const systemMsg: SystemModelMessage = {\n        role: \"system\",\n        content: message.content ?? \"\",\n      };\n      result.push(systemMsg);\n    } else if (message.role === \"developer\" && options.forwardDeveloperMessages) {\n      const systemMsg: SystemModelMessage = {\n        role: \"system\",\n        content: message.content ?? \"\",\n      };\n      result.push(systemMsg);\n    } else if (message.role === \"assistant\") {\n      const parts: Array<TextPart | ToolCallPart> = message.content ? [{ type: \"text\", text: message.content }] : [];\n\n      for (const toolCall of message.toolCalls ?? []) {\n        const toolCallPart: ToolCallPart = {\n          type: \"tool-call\",\n          toolCallId: toolCall.id,\n          toolName: toolCall.function.name,\n          input: JSON.parse(toolCall.function.arguments),\n        };\n        parts.push(toolCallPart);\n      }\n\n      const assistantMsg: AssistantModelMessage = {\n        role: \"assistant\",\n        content: parts,\n      };\n      result.push(assistantMsg);\n    } else if (message.role === \"user\") {\n      const userMsg: UserModelMessage = {\n        role: \"user\",\n        content: flattenUserMessageContent(message.content),\n      };\n      result.push(userMsg);\n    } else if (message.role === \"tool\") {\n      let toolName = \"unknown\";\n      // Find the tool name from the corresponding tool call\n      for (const msg of messages) {\n        if (msg.role === \"assistant\") {\n          for (const toolCall of msg.toolCalls ?? []) {\n            if (toolCall.id === message.toolCallId) {\n              toolName = toolCall.function.name;\n              break;\n            }\n          }\n        }\n      }\n\n      const toolResultPart: ToolResultPart = {\n        type: \"tool-result\",\n        toolCallId: message.toolCallId,\n        toolName: toolName,\n        output: {\n          type: \"text\",\n          value: message.content,\n        },\n      };\n\n      const toolMsg: ToolModelMessage = {\n        role: \"tool\",\n        content: [toolResultPart],\n      };\n      result.push(toolMsg);\n    }\n  }\n\n  return result;\n}\n\n/**\n * JSON Schema type definition\n */\ninterface JsonSchema {\n  type: \"object\" | \"string\" | \"number\" | \"integer\" | \"boolean\" | \"array\";\n  description?: string;\n  properties?: Record<string, JsonSchema>;\n  required?: string[];\n  items?: JsonSchema;\n}\n\n/**\n * Converts JSON Schema to Zod schema\n */\nexport function convertJsonSchemaToZodSchema(jsonSchema: JsonSchema, required: boolean): z.ZodSchema {\n  // Handle empty schemas {} (no input required) - treat as empty object\n  if (!jsonSchema.type) {\n    return required ? z.object({}) : z.object({}).optional();\n  }\n  if (jsonSchema.type === \"object\") {\n    const spec: { [key: string]: z.ZodSchema } = {};\n\n    if (!jsonSchema.properties || !Object.keys(jsonSchema.properties).length) {\n      return !required ? z.object(spec).optional() : z.object(spec);\n    }\n\n    for (const [key, value] of Object.entries(jsonSchema.properties)) {\n      spec[key] = convertJsonSchemaToZodSchema(value, jsonSchema.required ? jsonSchema.required.includes(key) : false);\n    }\n    let schema = z.object(spec).describe(jsonSchema.description ?? \"\");\n    return required ? schema : schema.optional();\n  } else if (jsonSchema.type === \"string\") {\n    let schema = z.string().describe(jsonSchema.description ?? \"\");\n    return required ? schema : schema.optional();\n  } else if (jsonSchema.type === \"number\" || jsonSchema.type === \"integer\") {\n    let schema = z.number().describe(jsonSchema.description ?? \"\");\n    return required ? schema : schema.optional();\n  } else if (jsonSchema.type === \"boolean\") {\n    let schema = z.boolean().describe(jsonSchema.description ?? \"\");\n    return required ? schema : schema.optional();\n  } else if (jsonSchema.type === \"array\") {\n    if (!jsonSchema.items) {\n      throw new Error(\"Array type must have items property\");\n    }\n    let itemSchema = convertJsonSchemaToZodSchema(jsonSchema.items, true);\n    let schema = z.array(itemSchema).describe(jsonSchema.description ?? \"\");\n    return required ? schema : schema.optional();\n  }\n  console.error(\"Invalid JSON schema:\", JSON.stringify(jsonSchema, null, 2));\n  throw new Error(\"Invalid JSON schema\");\n}\n\n/**\n * Converts AG-UI tools to Vercel AI SDK ToolSet\n */\nfunction isJsonSchema(obj: unknown): obj is JsonSchema {\n  if (typeof obj !== \"object\" || obj === null) return false;\n  const schema = obj as Record<string, unknown>;\n  // Empty objects {} are valid JSON schemas (no input required)\n  if (Object.keys(schema).length === 0) return true;\n  return (\n    typeof schema.type === \"string\" &&\n    [\"object\", \"string\", \"number\", \"integer\", \"boolean\", \"array\"].includes(schema.type)\n  );\n}\n\nexport function convertToolsToVercelAITools(tools: RunAgentInput[\"tools\"]): ToolSet {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const result: Record<string, any> = {};\n\n  for (const tool of tools) {\n    if (!isJsonSchema(tool.parameters)) {\n      throw new Error(`Invalid JSON schema for tool ${tool.name}`);\n    }\n    const zodSchema = convertJsonSchemaToZodSchema(tool.parameters, true);\n    result[tool.name] = createVercelAISDKTool({\n      description: tool.description,\n      inputSchema: zodSchema,\n    });\n  }\n\n  return result;\n}\n\n/**\n * Converts ToolDefinition array to Vercel AI SDK ToolSet\n */\nexport function convertToolDefinitionsToVercelAITools(tools: ToolDefinition[]): ToolSet {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const result: Record<string, any> = {};\n\n  for (const tool of tools) {\n    result[tool.name] = createVercelAISDKTool({\n      description: tool.description,\n      inputSchema: tool.parameters,\n      execute: tool.execute,\n    });\n  }\n\n  return result;\n}\n\n/**\n * Configuration for BuiltInAgent\n */\nexport interface BuiltInAgentConfiguration {\n  /**\n   * The model to use\n   */\n  model: BuiltInAgentModel | LanguageModel;\n  /**\n   * API key for the model provider (OpenAI, Anthropic, Google)\n   * If not provided, falls back to environment variables:\n   * - OPENAI_API_KEY for OpenAI models\n   * - ANTHROPIC_API_KEY for Anthropic models\n   * - GOOGLE_API_KEY for Google models\n   */\n  apiKey?: string;\n  /**\n   * Maximum number of steps/iterations for tool calling (default: 1)\n   */\n  maxSteps?: number;\n  /**\n   * Tool choice setting - how tools are selected for execution (default: \"auto\")\n   */\n  toolChoice?: ToolChoice<Record<string, unknown>>;\n  /**\n   * Maximum number of tokens to generate\n   */\n  maxOutputTokens?: number;\n  /**\n   * Temperature setting (range depends on provider)\n   */\n  temperature?: number;\n  /**\n   * Nucleus sampling (topP)\n   */\n  topP?: number;\n  /**\n   * Top K sampling\n   */\n  topK?: number;\n  /**\n   * Presence penalty\n   */\n  presencePenalty?: number;\n  /**\n   * Frequency penalty\n   */\n  frequencyPenalty?: number;\n  /**\n   * Sequences that will stop the generation\n   */\n  stopSequences?: string[];\n  /**\n   * Seed for deterministic results\n   */\n  seed?: number;\n  /**\n   * Maximum number of retries\n   */\n  maxRetries?: number;\n  /**\n   * Prompt for the agent\n   */\n  prompt?: string;\n  /**\n   * List of properties that can be overridden by forwardedProps.\n   */\n  overridableProperties?: OverridableProperty[];\n  /**\n   * Optional list of MCP server configurations\n   */\n  mcpServers?: MCPClientConfig[];\n  /**\n   * Optional tools available to the agent\n   */\n  tools?: ToolDefinition[];\n  /**\n   * Forward system-role messages from input to the LLM.\n   * Default: false\n   */\n  forwardSystemMessages?: boolean;\n  /**\n   * Forward developer-role messages from input to the LLM (as system messages).\n   * Default: false\n   */\n  forwardDeveloperMessages?: boolean;\n}\n\nexport class BuiltInAgent extends AbstractAgent {\n  private abortController?: AbortController;\n\n  constructor(private config: BuiltInAgentConfiguration) {\n    super();\n  }\n\n  /**\n   * Check if a property can be overridden by forwardedProps\n   */\n  canOverride(property: OverridableProperty): boolean {\n    return this.config?.overridableProperties?.includes(property) ?? false;\n  }\n\n  run(input: RunAgentInput): Observable<BaseEvent> {\n    return new Observable<BaseEvent>((subscriber) => {\n      // Emit RUN_STARTED event\n      const startEvent: RunStartedEvent = {\n        type: EventType.RUN_STARTED,\n        threadId: input.threadId,\n        runId: input.runId,\n      };\n      subscriber.next(startEvent);\n\n      // Resolve the model, passing API key if provided\n      const model = resolveModel(this.config.model, this.config.apiKey);\n\n      // Build prompt based on conditions\n      let systemPrompt: string | undefined = undefined;\n\n      // Check if we should build a prompt:\n      // - config.prompt is set, OR\n      // - input.context is non-empty, OR\n      // - input.state is non-empty and not an empty object\n      const hasPrompt = !!this.config.prompt;\n      const hasContext = input.context && input.context.length > 0;\n      const hasState =\n        input.state !== undefined &&\n        input.state !== null &&\n        !(typeof input.state === \"object\" && Object.keys(input.state).length === 0);\n\n      if (hasPrompt || hasContext || hasState) {\n        const parts: string[] = [];\n\n        // First: the prompt if any\n        if (hasPrompt) {\n          parts.push(this.config.prompt!);\n        }\n\n        // Second: context from the application\n        if (hasContext) {\n          parts.push(\"\\n## Context from the application\\n\");\n          for (const ctx of input.context) {\n            parts.push(`${ctx.description}:\\n${ctx.value}\\n`);\n          }\n        }\n\n        // Third: state from the application that can be edited\n        if (hasState) {\n          parts.push(\n            \"\\n## Application State\\n\" +\n              \"This is state from the application that you can edit by calling AGUISendStateSnapshot or AGUISendStateDelta.\\n\" +\n              `\\`\\`\\`json\\n${JSON.stringify(input.state, null, 2)}\\n\\`\\`\\`\\n`,\n          );\n        }\n\n        systemPrompt = parts.join(\"\");\n      }\n\n      // Convert messages and prepend system message if we have a prompt\n      const messages = convertMessagesToVercelAISDKMessages(input.messages, {\n        forwardSystemMessages: this.config.forwardSystemMessages,\n        forwardDeveloperMessages: this.config.forwardDeveloperMessages,\n      });\n      if (systemPrompt) {\n        messages.unshift({\n          role: \"system\",\n          content: systemPrompt,\n        });\n      }\n\n      // Merge tools from input and config\n      let allTools: ToolSet = convertToolsToVercelAITools(input.tools);\n      if (this.config.tools && this.config.tools.length > 0) {\n        const configTools = convertToolDefinitionsToVercelAITools(this.config.tools);\n        allTools = { ...allTools, ...configTools };\n      }\n\n      const streamTextParams: Parameters<typeof streamText>[0] = {\n        model,\n        messages,\n        tools: allTools,\n        toolChoice: this.config.toolChoice,\n        stopWhen: this.config.maxSteps ? stepCountIs(this.config.maxSteps) : undefined,\n        maxOutputTokens: this.config.maxOutputTokens,\n        temperature: this.config.temperature,\n        topP: this.config.topP,\n        topK: this.config.topK,\n        presencePenalty: this.config.presencePenalty,\n        frequencyPenalty: this.config.frequencyPenalty,\n        stopSequences: this.config.stopSequences,\n        seed: this.config.seed,\n        maxRetries: this.config.maxRetries,\n      };\n\n      // Apply forwardedProps overrides (if allowed)\n      if (input.forwardedProps && typeof input.forwardedProps === \"object\") {\n        const props = input.forwardedProps as Record<string, unknown>;\n\n        // Check and apply each overridable property\n        if (props.model !== undefined && this.canOverride(\"model\")) {\n          if (typeof props.model === \"string\" || typeof props.model === \"object\") {\n            // Accept any string or LanguageModel instance for model override\n            // Use the configured API key when resolving overridden models\n            streamTextParams.model = resolveModel(props.model as string | LanguageModel, this.config.apiKey);\n          }\n        }\n        if (props.toolChoice !== undefined && this.canOverride(\"toolChoice\")) {\n          // ToolChoice can be 'auto', 'required', 'none', or { type: 'tool', toolName: string }\n          const toolChoice = props.toolChoice;\n          if (\n            toolChoice === \"auto\" ||\n            toolChoice === \"required\" ||\n            toolChoice === \"none\" ||\n            (typeof toolChoice === \"object\" &&\n              toolChoice !== null &&\n              \"type\" in toolChoice &&\n              toolChoice.type === \"tool\")\n          ) {\n            streamTextParams.toolChoice = toolChoice as ToolChoice<Record<string, unknown>>;\n          }\n        }\n        if (typeof props.maxOutputTokens === \"number\" && this.canOverride(\"maxOutputTokens\")) {\n          streamTextParams.maxOutputTokens = props.maxOutputTokens;\n        }\n        if (typeof props.temperature === \"number\" && this.canOverride(\"temperature\")) {\n          streamTextParams.temperature = props.temperature;\n        }\n        if (typeof props.topP === \"number\" && this.canOverride(\"topP\")) {\n          streamTextParams.topP = props.topP;\n        }\n        if (typeof props.topK === \"number\" && this.canOverride(\"topK\")) {\n          streamTextParams.topK = props.topK;\n        }\n        if (typeof props.presencePenalty === \"number\" && this.canOverride(\"presencePenalty\")) {\n          streamTextParams.presencePenalty = props.presencePenalty;\n        }\n        if (typeof props.frequencyPenalty === \"number\" && this.canOverride(\"frequencyPenalty\")) {\n          streamTextParams.frequencyPenalty = props.frequencyPenalty;\n        }\n        if (Array.isArray(props.stopSequences) && this.canOverride(\"stopSequences\")) {\n          // Validate all elements are strings\n          if (props.stopSequences.every((item): item is string => typeof item === \"string\")) {\n            streamTextParams.stopSequences = props.stopSequences;\n          }\n        }\n        if (typeof props.seed === \"number\" && this.canOverride(\"seed\")) {\n          streamTextParams.seed = props.seed;\n        }\n        if (typeof props.maxRetries === \"number\" && this.canOverride(\"maxRetries\")) {\n          streamTextParams.maxRetries = props.maxRetries;\n        }\n      }\n\n      // Set up MCP clients if configured and process the stream\n      const mcpClients: Array<{ close: () => Promise<void> }> = [];\n\n      (async () => {\n        const abortController = new AbortController();\n        this.abortController = abortController;\n        let terminalEventEmitted = false;\n\n        try {\n          // Add AG-UI state update tools\n          streamTextParams.tools = {\n            ...streamTextParams.tools,\n            AGUISendStateSnapshot: createVercelAISDKTool({\n              description: \"Replace the entire application state with a new snapshot\",\n              inputSchema: z.object({\n                snapshot: z.any().describe(\"The complete new state object\"),\n              }),\n              execute: async ({ snapshot }) => {\n                return { success: true, snapshot };\n              },\n            }),\n            AGUISendStateDelta: createVercelAISDKTool({\n              description: \"Apply incremental updates to application state using JSON Patch operations\",\n              inputSchema: z.object({\n                delta: z\n                  .array(\n                    z.object({\n                      op: z.enum([\"add\", \"replace\", \"remove\"]).describe(\"The operation to perform\"),\n                      path: z.string().describe(\"JSON Pointer path (e.g., '/foo/bar')\"),\n                      value: z\n                        .any()\n                        .optional()\n                        .describe(\n                          \"The value to set. Required for 'add' and 'replace' operations, ignored for 'remove'.\",\n                        ),\n                    }),\n                  )\n                  .describe(\"Array of JSON Patch operations\"),\n              }),\n              execute: async ({ delta }) => {\n                return { success: true, delta };\n              },\n            }),\n          };\n\n          // Initialize MCP clients and get their tools\n          if (this.config.mcpServers && this.config.mcpServers.length > 0) {\n            for (const serverConfig of this.config.mcpServers) {\n              let transport;\n\n              if (serverConfig.type === \"http\") {\n                const url = new URL(serverConfig.url);\n                transport = new StreamableHTTPClientTransport(url, serverConfig.options);\n              } else if (serverConfig.type === \"sse\") {\n                transport = new SSEClientTransport(new URL(serverConfig.url), serverConfig.headers);\n              }\n\n              if (transport) {\n                const mcpClient = await createMCPClient({ transport });\n                mcpClients.push(mcpClient);\n\n                // Get tools from this MCP server and merge with existing tools\n                const mcpTools = await mcpClient.tools();\n                streamTextParams.tools = { ...streamTextParams.tools, ...mcpTools } as ToolSet;\n              }\n            }\n          }\n\n          // Call streamText and process the stream\n          const response = streamText({ ...streamTextParams, abortSignal: abortController.signal });\n\n          let messageId = randomUUID();\n\n          const toolCallStates = new Map<\n            string,\n            {\n              started: boolean;\n              hasArgsDelta: boolean;\n              ended: boolean;\n              toolName?: string;\n            }\n          >();\n\n          const ensureToolCallState = (toolCallId: string) => {\n            let state = toolCallStates.get(toolCallId);\n            if (!state) {\n              state = { started: false, hasArgsDelta: false, ended: false };\n              toolCallStates.set(toolCallId, state);\n            }\n            return state;\n          };\n\n          // Process fullStream events\n          for await (const part of response.fullStream) {\n            switch (part.type) {\n              case \"abort\":\n                const abortEndEvent: RunFinishedEvent = {\n                  type: EventType.RUN_FINISHED,\n                  threadId: input.threadId,\n                  runId: input.runId,\n                };\n                subscriber.next(abortEndEvent);\n                terminalEventEmitted = true;\n\n                // Complete the observable\n                subscriber.complete();\n                break;\n\n              case \"tool-input-start\": {\n                const toolCallId = part.id;\n                const state = ensureToolCallState(toolCallId);\n                state.toolName = part.toolName;\n                if (!state.started) {\n                  state.started = true;\n                  const startEvent: ToolCallStartEvent = {\n                    type: EventType.TOOL_CALL_START,\n                    parentMessageId: messageId,\n                    toolCallId,\n                    toolCallName: part.toolName,\n                  };\n                  subscriber.next(startEvent);\n                }\n                break;\n              }\n\n              case \"tool-input-delta\": {\n                const toolCallId = part.id;\n                const state = ensureToolCallState(toolCallId);\n                state.hasArgsDelta = true;\n                const argsEvent: ToolCallArgsEvent = {\n                  type: EventType.TOOL_CALL_ARGS,\n                  toolCallId,\n                  delta: part.delta,\n                };\n                subscriber.next(argsEvent);\n                break;\n              }\n\n              case \"tool-input-end\": {\n                // No direct event â€“ the subsequent \"tool-call\" part marks completion.\n                break;\n              }\n\n              case \"text-start\": {\n                // New text message starting - use the SDK-provided id\n                // Use randomUUID() if part.id is falsy or \"0\" to prevent message merging issues\n                const providedId = \"id\" in part ? part.id : undefined;\n                messageId = providedId && providedId !== \"0\" ? (providedId as typeof messageId) : randomUUID();\n                break;\n              }\n\n              case \"text-delta\": {\n                // Accumulate text content - in AI SDK 5.0, the property is 'text'\n                const textDelta = \"text\" in part ? part.text : \"\";\n                // Emit text chunk event\n                const textEvent: TextMessageChunkEvent = {\n                  type: EventType.TEXT_MESSAGE_CHUNK,\n                  role: \"assistant\",\n                  messageId,\n                  delta: textDelta,\n                };\n                subscriber.next(textEvent);\n                break;\n              }\n\n              case \"tool-call\": {\n                const toolCallId = part.toolCallId;\n                const state = ensureToolCallState(toolCallId);\n                state.toolName = part.toolName ?? state.toolName;\n\n                if (!state.started) {\n                  state.started = true;\n                  const startEvent: ToolCallStartEvent = {\n                    type: EventType.TOOL_CALL_START,\n                    parentMessageId: messageId,\n                    toolCallId,\n                    toolCallName: part.toolName,\n                  };\n                  subscriber.next(startEvent);\n                }\n\n                if (!state.hasArgsDelta && \"input\" in part && part.input !== undefined) {\n                  let serializedInput = \"\";\n                  if (typeof part.input === \"string\") {\n                    serializedInput = part.input;\n                  } else {\n                    try {\n                      serializedInput = JSON.stringify(part.input);\n                    } catch {\n                      serializedInput = String(part.input);\n                    }\n                  }\n\n                  if (serializedInput.length > 0) {\n                    const argsEvent: ToolCallArgsEvent = {\n                      type: EventType.TOOL_CALL_ARGS,\n                      toolCallId,\n                      delta: serializedInput,\n                    };\n                    subscriber.next(argsEvent);\n                    state.hasArgsDelta = true;\n                  }\n                }\n\n                if (!state.ended) {\n                  state.ended = true;\n                  const endEvent: ToolCallEndEvent = {\n                    type: EventType.TOOL_CALL_END,\n                    toolCallId,\n                  };\n                  subscriber.next(endEvent);\n                }\n                break;\n              }\n\n              case \"tool-result\": {\n                const toolResult = \"output\" in part ? part.output : null;\n                const toolName = \"toolName\" in part ? part.toolName : \"\";\n                toolCallStates.delete(part.toolCallId);\n\n                // Check if this is a state update tool\n                if (toolName === \"AGUISendStateSnapshot\" && toolResult && typeof toolResult === \"object\") {\n                  // Emit StateSnapshotEvent\n                  const stateSnapshotEvent: StateSnapshotEvent = {\n                    type: EventType.STATE_SNAPSHOT,\n                    snapshot: toolResult.snapshot,\n                  };\n                  subscriber.next(stateSnapshotEvent);\n                } else if (toolName === \"AGUISendStateDelta\" && toolResult && typeof toolResult === \"object\") {\n                  // Emit StateDeltaEvent\n                  const stateDeltaEvent: StateDeltaEvent = {\n                    type: EventType.STATE_DELTA,\n                    delta: toolResult.delta,\n                  };\n                  subscriber.next(stateDeltaEvent);\n                }\n\n                // Always emit the tool result event for the LLM\n                const resultEvent: ToolCallResultEvent = {\n                  type: EventType.TOOL_CALL_RESULT,\n                  role: \"tool\",\n                  messageId: randomUUID(),\n                  toolCallId: part.toolCallId,\n                  content: JSON.stringify(toolResult),\n                };\n                subscriber.next(resultEvent);\n                break;\n              }\n\n              case \"finish\":\n                // Emit run finished event\n                const finishedEvent: RunFinishedEvent = {\n                  type: EventType.RUN_FINISHED,\n                  threadId: input.threadId,\n                  runId: input.runId,\n                };\n                subscriber.next(finishedEvent);\n                terminalEventEmitted = true;\n\n                // Complete the observable\n                subscriber.complete();\n                break;\n\n              case \"error\": {\n                if (abortController.signal.aborted) {\n                  break;\n                }\n                const runErrorEvent: RunErrorEvent = {\n                  type: EventType.RUN_ERROR,\n                  message: part.error + \"\",\n                };\n                subscriber.next(runErrorEvent);\n                terminalEventEmitted = true;\n\n                // Handle error\n                subscriber.error(part.error);\n                break;\n              }\n            }\n          }\n\n          if (!terminalEventEmitted) {\n            if (abortController.signal.aborted) {\n              // Let the runner finalize the stream on stop requests so it can\n              // inject consistent closing events and a RUN_FINISHED marker.\n            } else {\n              const finishedEvent: RunFinishedEvent = {\n                type: EventType.RUN_FINISHED,\n                threadId: input.threadId,\n                runId: input.runId,\n              };\n              subscriber.next(finishedEvent);\n            }\n\n            terminalEventEmitted = true;\n            subscriber.complete();\n          }\n        } catch (error) {\n          if (abortController.signal.aborted) {\n            subscriber.complete();\n          } else {\n            const runErrorEvent: RunErrorEvent = {\n              type: EventType.RUN_ERROR,\n              message: error + \"\",\n            };\n            subscriber.next(runErrorEvent);\n            terminalEventEmitted = true;\n            subscriber.error(error);\n          }\n        } finally {\n          this.abortController = undefined;\n          await Promise.all(mcpClients.map((client) => client.close()));\n        }\n      })();\n\n      // Cleanup function\n      return () => {\n        // Cleanup MCP clients if stream is unsubscribed\n        Promise.all(mcpClients.map((client) => client.close())).catch(() => {\n          // Ignore cleanup errors\n        });\n      };\n    });\n  }\n\n  clone() {\n    const cloned = new BuiltInAgent(this.config);\n    // Copy middlewares from parent class\n    // @ts-expect-error - accessing protected property from parent\n    cloned.middlewares = [...this.middlewares];\n    return cloned;\n  }\n\n  abortRun(): void {\n    this.abortController?.abort();\n  }\n}\n\n/**\n * @deprecated Use BuiltInAgent instead\n */\nexport class BasicAgent extends BuiltInAgent {\n  constructor(config: BuiltInAgentConfiguration) {\n    super(config);\n    console.warn(\"BasicAgent is deprecated, use BuiltInAgent instead\");\n  }\n}\n\nexport type BasicAgentConfiguration = BuiltInAgentConfiguration;\n"],"mappings":"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","names":["startEvent"]}
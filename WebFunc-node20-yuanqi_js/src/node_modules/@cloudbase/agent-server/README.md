# @cloudbase/agent-server

å°† AG-UI å…¼å®¹çš„ Agent éƒ¨ç½²ä¸º HTTP æœåŠ¡ã€‚

## ä»€ä¹ˆæ˜¯ AG-UIï¼Ÿ

[AG-UI](https://ag-ui.com/) æ˜¯ä¸€ä¸ªå¼€æ”¾ã€è½»é‡çº§ã€åŸºäºäº‹ä»¶çš„åè®®ï¼Œç”¨äºæ ‡å‡†åŒ– AI Agent ä¸ç”¨æˆ·ç•Œé¢çš„äº¤äº’ã€‚å®ƒè®© Agent å¯ä»¥ï¼š

- å®æ—¶æµå¼å¯¹è¯
- åŒå‘çŠ¶æ€åŒæ­¥
- å‰ç«¯å·¥å…·é›†æˆï¼ˆClient Toolsï¼‰
- äººæœºåä½œï¼ˆHuman-in-the-loopï¼‰

## è¿™ä¸ªåŒ…è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ

- **å¿«é€Ÿéƒ¨ç½² Agent ä¸º HTTP æœåŠ¡**ï¼šä¸€è¡Œä»£ç å°† Agent éƒ¨ç½²ä¸ºæ”¯æŒ AG-UI åè®®çš„ HTTP æœåŠ¡
- **å¤šç«¯ç‚¹æ”¯æŒ**ï¼šè‡ªåŠ¨åˆ›å»º `/send-message`ã€`/healthz` ç­‰ç«¯ç‚¹
- **äº‘å‡½æ•°å…¼å®¹**ï¼šè‡ªåŠ¨é€‚é…è…¾è®¯äº‘å¼€å‘ HTTP äº‘å‡½æ•°ç¯å¢ƒ

### æ¶æ„å›¾

```mermaid
flowchart LR
    Client[AG-UI å®¢æˆ·ç«¯] -->|AG-UI åè®®| Server["@cloudbase/agent-server"]
    Server --> Adapter[Adapter<br/>LangGraph / LangChain]
    Adapter --> Agent[Agent æ¡†æ¶]
```

## é…åˆä½¿ç”¨

| åŒ…å | ä½œç”¨ |
|------|------|
| `@cloudbase/agent-adapter-langgraph` | LangGraph å·¥ä½œæµé€‚é…å™¨ |
| `@cloudbase/agent-adapter-langchain` | LangChain Agent é€‚é…å™¨ |
| `express` | HTTP æœåŠ¡æ¡†æ¶ |

## å®‰è£…

```bash
pnpm add @cloudbase/agent-server express
```

## å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€ï¼šä½¿ç”¨ runï¼ˆæœ€ç®€å•ï¼‰

```typescript
import { run } from "@cloudbase/agent-server";
import { LanggraphAgent } from "@cloudbase/agent-adapter-langgraph";
import { workflow } from "./workflow.js"; // ä½ çš„ LangGraph å·¥ä½œæµ

run({
  createAgent: () => ({
    agent: new LanggraphAgent({ workflow }),
  }),
  port: 9000,
});
```

### æ–¹å¼äºŒï¼šä½¿ç”¨ createExpressServer

åˆ›å»ºä¸€ä¸ªé…ç½®å¥½çš„ Express åº”ç”¨ï¼š

```typescript
import { createExpressServer } from "@cloudbase/agent-server";
import { LanggraphAgent } from "@cloudbase/agent-adapter-langgraph";
import { workflow } from "./workflow.js";

const app = createExpressServer({
  createAgent: () => ({
    agent: new LanggraphAgent({ workflow }),
  }),
});

app.listen(9000, () => console.log("Listening on 9000!"));
```

### æ–¹å¼ä¸‰ï¼šä½¿ç”¨ createExpressRoutes

å°†è·¯ç”±æŒ‚è½½åˆ°ç°æœ‰çš„ Express åº”ç”¨ï¼š

```typescript
import { createExpressRoutes } from "@cloudbase/agent-server";
import { LanggraphAgent } from "@cloudbase/agent-adapter-langgraph";
import { workflow } from "./workflow.js";
import express from "express";

const app = express();

createExpressRoutes({
  createAgent: () => ({
    agent: new LanggraphAgent({ workflow }),
  }),
  express: app,
});

app.listen(9000, () => console.log("Listening on 9000!"));
```

## API å‚è€ƒ

### run

åˆ›å»ºå¹¶å¯åŠ¨ HTTP æœåŠ¡ã€‚

```typescript
run({
  createAgent,
  port: 9000,
});
```

**å‚æ•°ï¼š**

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `createAgent` | `AgentCreator` | Agent åˆ›å»ºå‡½æ•°ï¼Œè§ä¸‹æ–¹è¯´æ˜ |
| `port` | `number \| string` | ç›‘å¬ç«¯å£ |
| `basePath` | `string` | å¯é€‰ï¼Œè·¯ç”±åŸºç¡€è·¯å¾„ï¼Œé»˜è®¤ä¸º `/`ï¼Œäº‘å‡½æ•°ç¯å¢ƒé»˜è®¤ä¸º `/v1/aibot/bots/:agentId/` |
| `cors` | `boolean \| CorsOptions` | å¯é€‰ï¼ŒCORS é…ç½®ï¼Œé»˜è®¤å¯ç”¨ |
| `logger` | `Logger` | å¯é€‰ï¼Œæ—¥å¿—å®ä¾‹ï¼Œç”¨äºè®°å½•æœåŠ¡ç«¯æ—¥å¿— |

### createExpressServer

åˆ›å»ºä¸€ä¸ªé…ç½®å¥½çš„ Express åº”ç”¨ã€‚

```typescript
const app = createExpressServer({
  createAgent,
  cors: true,       // å¯é€‰ï¼Œé»˜è®¤å¯ç”¨ CORS
});
```

**å‚æ•°ï¼š**

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `createAgent` | `AgentCreator` | Agent åˆ›å»ºå‡½æ•°ï¼Œè§ä¸‹æ–¹è¯´æ˜ |
| `basePath` | `string` | å¯é€‰ï¼Œè·¯ç”±åŸºç¡€è·¯å¾„ |
| `cors` | `boolean \| CorsOptions` | å¯é€‰ï¼ŒCORS é…ç½®ï¼Œé»˜è®¤å¯ç”¨ |
| `logger` | `Logger` | å¯é€‰ï¼Œæ—¥å¿—å®ä¾‹ï¼Œç”¨äºè®°å½•æœåŠ¡ç«¯æ—¥å¿— |

### createExpressRoutes

å°† AG-UI è·¯ç”±æŒ‚è½½åˆ°ç°æœ‰çš„ Express åº”ç”¨ã€‚

```typescript
createExpressRoutes({
  createAgent,
  express: app,
  basePath,         // å¯é€‰
});
```

**å‚æ•°ï¼š**

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `createAgent` | `AgentCreator` | Agent åˆ›å»ºå‡½æ•°ï¼Œè§ä¸‹æ–¹è¯´æ˜ |
| `express` | `Express` | Express åº”ç”¨å®ä¾‹ |
| `basePath` | `string` | å¯é€‰ï¼Œè·¯ç”±åŸºç¡€è·¯å¾„ï¼Œé»˜è®¤ä¸º `/`ï¼Œäº‘å‡½æ•°ç¯å¢ƒé»˜è®¤ä¸º `/v1/aibot/bots/:agentId/` |
| `logger` | `Logger` | å¯é€‰ï¼Œæ—¥å¿—å®ä¾‹ï¼Œç”¨äºè®°å½•æœåŠ¡ç«¯æ—¥å¿— |

## è‡ªåŠ¨åˆ›å»ºçš„ç«¯ç‚¹

| ç«¯ç‚¹ | è¯´æ˜ |
|------|------|
| `{basePath}send-message` | AG-UI æ¶ˆæ¯å‘é€ç«¯ç‚¹ |
| `{basePath}healthz` | å¥åº·æ£€æŸ¥ç«¯ç‚¹ |

## createAgent å‚æ•°

`createAgent` è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼š
- `agent`ï¼šç¬¦åˆ [AG-UI åè®®](https://docs.ag-ui.com) çš„ Agent
- `cleanup`ï¼šå¯é€‰ï¼Œè¯·æ±‚ç»“æŸåçš„æ¸…ç†å‡½æ•°

```typescript
type AgentCreator = (context?: {
  request: Request;     // å½“å‰ HTTP è¯·æ±‚ï¼ˆWeb Standard Requestï¼‰
  logger?: Logger;      // æ—¥å¿—å®ä¾‹ï¼ˆå¸¦ requestId ä¸Šä¸‹æ–‡ï¼‰
  requestId?: string;   // è¯·æ±‚è¿½è¸ª ID
}) => AgentCreatorResult | Promise<AgentCreatorResult>; // æ”¯æŒå¼‚æ­¥

type AgentCreatorResult = {
  agent: AbstractAgent | { toAGUIAgent(): AbstractAgent }; // AG-UI å…¼å®¹çš„ Agent
  cleanup?: () => void; // å¯é€‰ï¼Œæ¸…ç†å‡½æ•°
};
```

ä½¿ç”¨é€‚é…å™¨å°†ä½ çš„ Agent æ¡†æ¶è½¬æ¢ä¸º AG-UI å…¼å®¹çš„ Agentï¼š

| é€‚é…å™¨ | åŒ…å | è¯´æ˜ |
|--------|------|------|
| `LanggraphAgent` | `@cloudbase/agent-adapter-langgraph` | LangGraph å·¥ä½œæµé€‚é…å™¨ |
| `LangchainAgent` | `@cloudbase/agent-adapter-langchain` | LangChain Agent é€‚é…å™¨ |

```typescript
import { LanggraphAgent } from "@cloudbase/agent-adapter-langgraph";

createAgent: () => ({
  agent: new LanggraphAgent({ workflow }),
})
```

**é«˜çº§ç”¨æ³•ï¼š** `createAgent` å¯ä»¥æ¥æ”¶è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œä¹Ÿæ”¯æŒå¼‚æ­¥ï¼š

```typescript
createAgent: async (context) => {
  console.log("Request ID:", context.requestId);
  return { agent: new LanggraphAgent({ workflow }) };
}
```

## Logger

`logger` å‚æ•°ç”¨äºè®°å½•æœåŠ¡ç«¯æ—¥å¿—ã€‚éœ€è¦å®ç°ä»¥ä¸‹æ¥å£ï¼š

```typescript
interface Logger {
  info?(message: string): void;
  info?(obj: object, message?: string): void;
  debug?(message: string): void;
  debug?(obj: object, message?: string): void;
  warn?(message: string): void;
  warn?(obj: object, message?: string): void;
  error?(message: string): void;
  error?(obj: object, message?: string): void;
  trace?(message: string): void;
  trace?(obj: object, message?: string): void;
  child?(bindings: object): Logger; // åˆ›å»ºå¸¦ä¸Šä¸‹æ–‡çš„å­ logger
}
```

**ç¤ºä¾‹ï¼š**

```typescript
// å¼€å‘ç¯å¢ƒï¼šä½¿ç”¨ console
run({ createAgent, logger: console, port: 9000 });

// ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨ pino
import pino from "pino";
run({ createAgent, logger: pino({ level: "info" }), port: 9000 });
```

## æ–‡æ¡£

ğŸ“š å®Œæ•´æ–‡æ¡£è¯·å‚é˜… [äº‘å¼€å‘ Agent å¼€å‘æŒ‡å—](https://docs.cloudbase.net/ai/agent-development/)

## ç›¸å…³èµ„æº

- [AG-UI åè®®](https://docs.cloudbase.net/ai/agent-development/ag-ui-protocol)
- [æ¡†æ¶å¼€å‘æŒ‡å—](https://docs.cloudbase.net/ai/agent-development/frameworks/)
- [éƒ¨ç½²æŒ‡å—](https://docs.cloudbase.net/ai/agent-development/deploy/)

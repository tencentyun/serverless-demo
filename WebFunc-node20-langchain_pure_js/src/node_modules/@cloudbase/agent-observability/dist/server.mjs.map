{"version":3,"sources":["../src/server/setup.ts","../src/server/config.ts"],"sourcesContent":["/**\n * Observability setup implementation for AG-Kit Server.\n *\n * Merges configuration from environment variables and parameters,\n * then applies each exporter configuration.\n *\n * @packageDocumentation\n */\n\nimport type {\n  BatchConfig,\n  ObservabilityConfig,\n  ConsoleTraceConfig,\n  OTLPTraceConfig,\n  CustomTraceConfig,\n} from './config';\n\nexport type {\n  BatchConfig,\n  ObservabilityConfig,\n  ConsoleTraceConfig,\n  OTLPTraceConfig,\n  CustomTraceConfig,\n} from './config';\n\n/**\n * Environment variable truthy values.\n * Matches Python SDK implementation for consistency.\n */\nconst TRUTHY_ENV_VALUES = new Set(['true', '1', 'yes', 'on']);\n\n/**\n * Merged configuration result.\n * Console config allows merge (param overrides env),\n * while OTLP and custom configs are arrays (additive).\n */\ninterface MergedConfig {\n  console?: ConsoleTraceConfig | null;\n  otlp: OTLPTraceConfig[];\n  custom: CustomTraceConfig[];\n}\n\n/**\n * Default batch configuration.\n */\nconst DEFAULT_BATCH_CONFIG: Required<BatchConfig> = {\n  maxExportBatchSize: 100,\n  scheduledDelayMillis: 5000,\n  maxQueueSize: 2048,\n  exportTimeoutMillis: 30000,\n};\n\n/**\n * Merge environment variable and parameter configurations.\n *\n * - AUTO_TRACES_STDOUT env adds a console config\n * - Parameter configs override/extend env configs\n */\nfunction mergeConfigs(paramConfigs: ObservabilityConfig[]): MergedConfig {\n  const result: MergedConfig = {\n    console: null,\n    otlp: [],\n    custom: [],\n  };\n\n  // 1. Check AUTO_TRACES_STDOUT env\n  const autoTracesStdout = process.env.AUTO_TRACES_STDOUT?.toLowerCase() || '';\n  if (TRUTHY_ENV_VALUES.has(autoTracesStdout)) {\n    result.console = { type: 'console' };\n    console.debug(\n      `[Observability] AUTO_TRACES_STDOUT=${autoTracesStdout}, console exporter enabled`\n    );\n  }\n\n  // 2. Process parameter configs\n  for (const config of paramConfigs) {\n    switch (config.type) {\n      case 'console':\n        // Parameter overrides env (merge batch config)\n        result.console = { ...result.console, ...config };\n        break;\n\n      case 'otlp':\n        result.otlp.push(config);\n        break;\n\n      case 'custom':\n        result.custom.push(config);\n        break;\n    }\n  }\n\n  return result;\n}\n\n/**\n * Apply batch configuration with defaults.\n */\nfunction resolveBatchConfig(batch?: BatchConfig): Required<BatchConfig> {\n  return { ...DEFAULT_BATCH_CONFIG, ...batch };\n}\n\n/**\n * Safe wrapper for exporter setup functions.\n * Ensures individual exporter failures don't crash the entire setup.\n */\nasync function safeSetup(\n  name: string,\n  setupFn: () => Promise<void>\n): Promise<void> {\n  try {\n    await setupFn();\n  } catch (error) {\n    console.warn(\n      `[Observability] ${name} setup failed (non-fatal): ${\n        error instanceof Error ? error.message : String(error)\n      }`\n    );\n    // Don't rethrow - allow other exporters to continue\n  }\n}\n\n/**\n * Setup console exporter.\n */\nasync function setupConsoleExporter(config: ConsoleTraceConfig): Promise<void> {\n  const { trace } = await import('@opentelemetry/api');\n  const { resourceFromAttributes } = await import('@opentelemetry/resources');\n  const { NodeTracerProvider } = await import('@opentelemetry/sdk-trace-node');\n  const { ConsoleSpanExporter, BatchSpanProcessor } = await import(\n    '@opentelemetry/sdk-trace-base'\n  );\n\n  const batchConfig = resolveBatchConfig(config.batch);\n\n  // Check if a real TracerProvider already exists\n  let provider = trace.getTracerProvider();\n  const isRealProvider = 'addSpanProcessor' in provider;\n\n  if (isRealProvider) {\n    // Add processor to existing provider\n    const exporter = new ConsoleSpanExporter();\n    const processor = new BatchSpanProcessor(exporter, batchConfig);\n    (provider as any).addSpanProcessor(processor);\n\n    console.info(\n      `[Observability] Console exporter configured (batch=${batchConfig.maxExportBatchSize}, ` +\n        `delay=${batchConfig.scheduledDelayMillis}ms)`\n    );\n  } else {\n    // Create new provider with console exporter\n    const resource = resourceFromAttributes({\n      'service.name': process.env.OTEL_SERVICE_NAME || 'ag-ui-server',\n      'service.version': '1.0.0',\n    });\n\n    const exporter = new ConsoleSpanExporter();\n    const processor = new BatchSpanProcessor(exporter, batchConfig);\n\n    const tracerProvider = new NodeTracerProvider({\n      resource,\n      spanProcessors: [processor],\n    });\n\n    tracerProvider.register();\n\n    console.info(\n      `[Observability] Console exporter configured (batch=${batchConfig.maxExportBatchSize}, ` +\n        `delay=${batchConfig.scheduledDelayMillis}ms)`\n    );\n  }\n}\n\n/**\n * Setup OTLP exporter.\n */\nasync function setupOTLPExporter(config: OTLPTraceConfig): Promise<void> {\n  const { trace } = await import('@opentelemetry/api');\n  const { resourceFromAttributes } = await import('@opentelemetry/resources');\n  const { NodeTracerProvider } = await import('@opentelemetry/sdk-trace-node');\n  const { OTLPTraceExporter } = await import('@opentelemetry/exporter-trace-otlp-http');\n  const { BatchSpanProcessor } = await import('@opentelemetry/sdk-trace-base');\n\n  const batchConfig = resolveBatchConfig(config.batch);\n\n  // Check if a real TracerProvider already exists\n  let provider = trace.getTracerProvider();\n  const isRealProvider = 'addSpanProcessor' in provider;\n\n  if (isRealProvider) {\n    // Add processor to existing provider\n    const exporter = new OTLPTraceExporter({\n      url: config.url,\n      headers: config.headers,\n      timeoutMillis: config.timeout ?? 10000,\n    });\n\n    const processor = new BatchSpanProcessor(exporter, batchConfig);\n    (provider as any).addSpanProcessor(processor);\n\n    console.info(\n      `[Observability] OTLP exporter configured (url=${config.url}, ` +\n        `batch=${batchConfig.maxExportBatchSize}, delay=${batchConfig.scheduledDelayMillis}ms)`\n    );\n  } else {\n    // Create new provider with OTLP exporter\n    const resource = resourceFromAttributes({\n      'service.name': process.env.OTEL_SERVICE_NAME || 'ag-ui-server',\n      'service.version': '1.0.0',\n    });\n\n    const exporter = new OTLPTraceExporter({\n      url: config.url,\n      headers: config.headers,\n      timeoutMillis: config.timeout ?? 10000,\n    });\n\n    const processor = new BatchSpanProcessor(exporter, batchConfig);\n\n    const tracerProvider = new NodeTracerProvider({\n      resource,\n      spanProcessors: [processor],\n    });\n\n    tracerProvider.register();\n\n    console.info(\n      `[Observability] OTLP exporter configured (url=${config.url}, ` +\n        `batch=${batchConfig.maxExportBatchSize}, delay=${batchConfig.scheduledDelayMillis}ms)`\n    );\n  }\n}\n\n/**\n * Setup custom exporter.\n */\nasync function setupCustomExporter(config: CustomTraceConfig): Promise<void> {\n  await config.setup();\n  console.info(`[Observability] Custom exporter setup completed`);\n}\n\n/**\n * Setup observability from merged configuration.\n *\n * @internal\n */\nasync function applyMergedConfigs(merged: MergedConfig): Promise<void> {\n  const setupTasks: Promise<void>[] = [];\n\n  // Apply console (non-blocking)\n  if (merged.console) {\n    setupTasks.push(safeSetup('Console exporter', () => setupConsoleExporter(merged.console!)));\n  }\n\n  // Apply otlp (non-blocking)\n  for (const otlp of merged.otlp) {\n    setupTasks.push(safeSetup(`OTLP exporter (${otlp.url})`, () => setupOTLPExporter(otlp)));\n  }\n\n  // Apply custom (non-blocking)\n  for (const custom of merged.custom) {\n    setupTasks.push(safeSetup('Custom exporter', () => setupCustomExporter(custom)));\n  }\n\n  // Wait for all exporters to complete (or fail gracefully)\n  await Promise.all(setupTasks);\n\n  if (merged.console || merged.otlp.length > 0 || merged.custom.length > 0) {\n    console.info(`[Observability] Setup completed`);\n  }\n}\n\n/**\n * Setup observability from configuration.\n *\n * Merges environment variable (AUTO_TRACES_STDOUT) with parameter configs,\n * then applies each exporter configuration.\n *\n * Environment variables act as presets, parameter configs override or extend.\n *\n * Returns a promise that resolves when setup is complete. This allows callers\n * to await initialization before proceeding, eliminating race conditions.\n *\n * The returned promise is cached - subsequent calls return the same promise\n * to avoid duplicate initialization.\n *\n * @param configs - Observability configuration(s)\n *\n * @example\n * ```typescript\n * // Console only (from env)\n * await setupObservability();\n *\n * // Console + OTLP\n * await setupObservability([\n *   { type: 'console' },\n *   { type: 'otlp', url: 'http://localhost:4318/v1/traces' }\n * ]);\n *\n * // OTLP only\n * await setupObservability({\n *   type: 'otlp',\n *   url: 'https://cloud.langfuse.com/api/public/otlp/v1/traces',\n *   headers: { 'Authorization': 'Basic xxx' }\n * });\n * ```\n *\n * @public\n */\n\nlet setupPromise: Promise<void> | null = null;\n\nexport async function setupObservability(\n  configs?: ObservabilityConfig | ObservabilityConfig[]\n): Promise<void> {\n  // Return cached promise if setup is in progress or completed\n  if (setupPromise) {\n    return setupPromise;\n  }\n\n  // Create the setup promise\n  setupPromise = (async () => {\n    try {\n      // Normalize to array\n      const configsArray = configs\n        ? Array.isArray(configs)\n          ? configs\n          : [configs]\n        : [];\n\n      // Merge env and parameter configs\n      const merged = mergeConfigs(configsArray);\n\n      // Apply merged configs\n      await applyMergedConfigs(merged);\n    } catch (error) {\n      // Reset promise on error to allow retry\n      setupPromise = null;\n      // Silent failure - observability should never block main flow\n      console.warn(\n        `[Observability] Setup failed: ${\n          error instanceof Error ? error.message : String(error)\n        }`\n      );\n    }\n  })();\n\n  return setupPromise;\n}\n","/**\n * Observability configuration types for AG-Kit Server.\n *\n * Provides a unified configuration interface for trace exporters:\n * - Console: Development/debugging output\n * - OTLP: Production export to Langfuse, Jaeger, etc.\n * - Custom: User-defined setup logic\n *\n * @packageDocumentation\n */\n\n/**\n * Trace exporter type constants.\n *\n * @example\n * ```typescript\n * import { ExporterType } from '@cloudbase/agent-observability/server';\n *\n * { type: ExporterType.Console }\n * { type: ExporterType.OTLP }\n * { type: ExporterType.Custom }\n * ```\n *\n * @public\n */\nexport const ExporterType = {\n  /** Console exporter - outputs traces to stdout */\n  Console: 'console',\n  /** OTLP exporter - sends traces to OTLP-compatible backend */\n  OTLP: 'otlp',\n  /** Custom exporter - user-defined setup logic */\n  Custom: 'custom',\n} as const;\n\n/**\n * Trace exporter type literal values.\n *\n * @public\n */\nexport type ExporterType = typeof ExporterType[keyof typeof ExporterType];\n\n/**\n * Batch processing configuration for span exporters.\n *\n * Used by BatchSpanProcessor to optimize performance:\n * - Collects spans in memory and exports them in batches\n * - Reduces I/O operations (console) or network requests (OTLP)\n * - Recommended for production environments\n *\n * @public\n */\nexport interface BatchConfig {\n  /** Maximum number of spans per export batch (default: 100) */\n  maxExportBatchSize?: number;\n  /** Maximum delay in milliseconds before exporting (default: 5000) */\n  scheduledDelayMillis?: number;\n  /** Maximum queue size (default: 2048) */\n  maxQueueSize?: number;\n  /** Export timeout in milliseconds (default: 30000) */\n  exportTimeoutMillis?: number;\n}\n\n/**\n * Console trace exporter configuration.\n *\n * Outputs traces to stdout in JSON format using ConsoleSpanExporter.\n * Useful for development and debugging.\n *\n * @example\n * ```typescript\n * import { ExporterType } from '@cloudbase/agent-observability/server';\n *\n * { type: ExporterType.Console }\n * { type: ExporterType.Console, batch: { maxExportBatchSize: 200 } }\n * ```\n *\n * @public\n */\nexport interface ConsoleTraceConfig {\n  /** Discriminator for console exporter */\n  type: typeof ExporterType.Console;\n  /** Optional batch processing configuration */\n  batch?: BatchConfig;\n}\n\n/**\n * OTLP trace exporter configuration.\n *\n * Exports traces via OTLP protocol to any compatible backend:\n * - Langfuse: https://cloud.langfuse.com/api/public/otlp/v1/traces\n * - Jaeger: http://localhost:4318/v1/traces\n * - OTel Collector: custom endpoint\n *\n * @example\n * ```typescript\n * import { ExporterType } from '@cloudbase/agent-observability/server';\n *\n * {\n *   type: ExporterType.OTLP,\n *   url: 'https://cloud.langfuse.com/api/public/otlp/v1/traces',\n *   headers: {\n *     'Authorization': 'Basic ' + btoa('pk-lf-xxx:sk-lf-xxx')\n *   }\n * }\n * ```\n *\n * @public\n */\nexport interface OTLPTraceConfig {\n  /** Discriminator for OTLP exporter */\n  type: typeof ExporterType.OTLP;\n  /** OTLP endpoint URL (http/https) */\n  url: string;\n  /** Optional HTTP headers for authentication */\n  headers?: Record<string, string>;\n  /** Request timeout in milliseconds (default: 10000) */\n  timeout?: number;\n  /** Optional batch processing configuration */\n  batch?: BatchConfig;\n}\n\n/**\n * Custom trace exporter configuration.\n *\n * Allows users to provide custom trace setup logic.\n * Useful for integrations not covered by console/otlp.\n *\n * @example\n * ```typescript\n * import { ExporterType } from '@cloudbase/agent-observability/server';\n *\n * {\n *   type: ExporterType.Custom,\n *   setup: async () => {\n *     const exporter = new MyCustomExporter();\n *     const provider = new BasicTracerProvider();\n *     provider.addSpanProcessor(new SimpleSpanProcessor(exporter));\n *     provider.register();\n *   }\n * }\n * ```\n *\n * @public\n */\nexport interface CustomTraceConfig {\n  /** Discriminator for custom setup */\n  type: typeof ExporterType.Custom;\n  /** User-defined setup function */\n  setup: () => Promise<void> | void;\n}\n\n/**\n * Union type of all supported trace exporter configurations.\n *\n * @public\n */\nexport type ObservabilityConfig =\n  | ConsoleTraceConfig\n  | OTLPTraceConfig\n  | CustomTraceConfig;\n"],"mappings":"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","names":[]}